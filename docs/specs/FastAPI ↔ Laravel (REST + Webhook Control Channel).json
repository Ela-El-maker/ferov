{
  "FastAPI_Laravel_Interface": {
    "version": "1.0",
    "purpose": "Defines the REST + webhook protocol between FastAPI (device controller) and Laravel (auth, policy, CA, command orchestrator).",
    "transport": "HTTPS (TLS 1.3)",
    "content_type": "application/json",
    "signature": "Laravel signs outbound webhooks using Ed25519; FastAPI signs inbound requests via service key",

    "Endpoints": {
      "Laravel_to_FastAPI": {
        "description": "Laravel pushes commands, policies, and updates into FastAPI.",
        "base_url": "https://fastapi.internal/api/v1",

        "POST_/command/dispatch": {
          "purpose": "Laravel sends a fully authorized command envelope to FastAPI for device routing.",
          "request_schema": {
            "command_id": "UUID",
            "device_id": "string",
            "trace_id": "UUID",
            "seq": "integer",
            "envelope": {
              "header": {
                "version": "string",
                "timestamp": "ISO8601",
                "ttl_seconds": "integer",
                "priority": "string",
                "requires_ack": "boolean",
                "long_running": "boolean"
              },
              "body": {
                "method": "string",
                "params": "object",
                "sensitive": "boolean"
              },
              "meta": {
                "origin_user_id": "string",
                "enc": "string (none|aes256gcm)",
                "enc_key_id": "string|null",
                "policy_version": "string"
              },
              "sig": "string (Laravel signature)"
            }
          },
          "response_schema": {
            "status": "'queued'|'dispatched'|'backpressure'|'device_offline'",
            "device_id": "string",
            "command_id": "UUID",
            "reason": "string|null"
          }
        },

        "POST_/policy/push": {
          "purpose": "Laravel broadcasts new policy bundle to FastAPI for redistribution.",
          "request_schema": {
            "policy_version": "string",
            "policy_hash": "sha256",
            "policy_url": "string",
            "signed_at": "ISO8601",
            "signature": "Ed25519 signature"
          },
          "response_schema": {
            "status": "'accepted'|'rejected'",
            "reason": "string|null"
          }
        },

        "POST_/update/deploy": {
          "purpose": "Laravel instructs FastAPI to announce a new OTA update to devices.",
          "request_schema": {
            "release_id": "string",
            "version": "string",
            "manifest_url": "string",
            "signature_url": "string",
            "sha256": "string",
            "min_os_build": "string",
            "rollout_stage": "string ('canary'|'beta'|'general')",
            "policy": {
              "auto_install": "boolean",
              "allow_reboot": "boolean"
            }
          },
          "response_schema": {
            "status": "'broadcasted'|'queued'|'failed'",
            "reason": "string|null"
          }
        }
      },


      "FastAPI_to_Laravel": {
        "description": "FastAPI reports device activity, command results, telemetry summaries, and attestation status.",
        "base_url": "https://laravel.internal/api/v1/webhook",

        "POST_/device/online": {
          "purpose": "FastAPI notifies Laravel that a device is online.",
          "request_schema": {
            "device_id": "string",
            "session_id": "UUID",
            "agent_version": "string",
            "os_build": "string",
            "attestation_hash": "string",
            "connected_at": "ISO8601"
          },
          "response_schema": {
            "status": "'ack'"
          }
        },

        "POST_/device/offline": {
          "purpose": "FastAPI notifies Laravel a device disconnected.",
          "request_schema": {
            "device_id": "string",
            "session_id": "UUID",
            "last_seen": "ISO8601",
            "reason": "string ('disconnect'|'error'|'timeout')"
          },
          "response_schema": {
            "status": "'ack'"
          }
        },

        "POST_/command/result": {
          "purpose": "Agent → FastAPI → Laravel final execution result.",
          "request_schema": {
            "command_id": "UUID",
            "device_id": "string",
            "trace_id": "UUID",
            "execution_state": "'completed'|'failed'|'partial'|'executing'",
            "result": {
              "status": "'ok'|'error'",
              "notes": "string|null",
              "artifact_url": "string|null",
              "artifact_checksum": "string|null"
            },
            "error_code": "integer|null",
            "error_message": "string|null",
            "timestamp": "ISO8601"
          },
          "response_schema": {
            "status": "'received'",
            "audit_id": "UUID"
          }
        },

        "POST_/command/ack": {
          "purpose": "FastAPI forwards Agent command acknowledgment.",
          "request_schema": {
            "command_id": "UUID",
            "device_id": "string",
            "status": "'received'|'rejected'",
            "reason": "string|null",
            "timestamp": "ISO8601"
          },
          "response_schema": {
            "status": "'ok'"
          }
        },

        "POST_/telemetry/summary": {
          "purpose": "FastAPI submits aggregated telemetry (hourly or batch).",
          "request_schema": {
            "device_id": "string",
            "timestamp": "ISO8601",
            "rollup": {
              "avg_cpu": "number",
              "avg_ram": "number",
              "avg_disk": "number",
              "max_cpu": "number",
              "risk_score_avg": "number"
            }
          },
          "response_schema": {
            "status": "'ok'"
          }
        },

        "POST_/security/attestation": {
          "purpose": "FastAPI sends attestation results from the Agent.",
          "request_schema": {
            "device_id": "string",
            "timestamp": "ISO8601",
            "attestation": {
              "agent_hash": "string",
              "kernelservice_hash": "string",
              "tpm_quote": "string|null",
              "status": "'pass'|'mismatch'|'unknown'"
            }
          },
          "response_schema": {
            "status": "'ack'",
            "action_required": "'none'|'quarantine'|'notify'"
          }
        }
      }
    },

    "EventContracts": {
      "FastAPI_to_Laravel": {
        "command_finalized": {
          "trigger": "COMMAND_RESULT from Agent",
          "guarantee": "Laravel will persist to DB and append audit.",
          "failure_mode": "FastAPI queues to DLQ topic and retries."
        },
        "device_presence_change": {
          "trigger": "Agent CONNECT/DISCONNECT",
          "guarantee": "Laravel updates device last_seen and presence flags."
        }
      },

      "Laravel_to_FastAPI": {
        "command_dispatch": {
          "trigger": "User issues command",
          "guarantee": "FastAPI routes to WSS-connected Agent if online."
        },
        "policy_broadcast": {
          "trigger": "Policy version changed in Laravel",
          "guarantee": "FastAPI stores latest hash + distributes over WSS."
        }
      }
    },

    "Security": {
      "InboundRequestsToFastAPI": {
        "auth": "Laravel signs with service private key",
        "header": "X-Laravel-Signature: base64-ed25519",
        "verify": "FastAPI verifies using Laravel’s public key"
      },
      "OutboundRequestsToLaravel": {
        "auth": "FastAPI signs using its service key",
        "header": "X-FastAPI-Signature",
        "verify": "Laravel verifies using FastAPI’s public key"
      },
      "RateLimits": {
        "command_dispatch": "50 requests per second",
        "telemetry_summary": "300 requests per minute"
      }
    },

    "Examples": {
      "Laravel_Dispatch_Command": {
        "request": {
          "command_id": "CMD-123",
          "device_id": "PC001",
          "trace_id": "TRACE-111",
          "seq": 1,
          "envelope": {
            "header": {
              "version": "1.1",
              "timestamp": "2025-11-22T12:00:00Z",
              "ttl_seconds": 300,
              "priority": "normal",
              "requires_ack": true,
              "long_running": false
            },
            "body": {
              "method": "lock_screen",
              "params": {},
              "sensitive": false
            },
            "meta": {
              "origin_user_id": "UID001",
              "enc": "none",
              "enc_key_id": null,
              "policy_version": "policy-2025-11-01"
            },
            "sig": "sig_laravel"
          }
        },
        "response": {
          "status": "dispatched",
          "device_id": "PC001",
          "command_id": "CMD-123",
          "reason": null
        }
      },

      "FastAPI_Command_Result_To_Laravel": {
        "request": {
          "command_id": "CMD-123",
          "device_id": "PC001",
          "trace_id": "TRACE-111",
          "execution_state": "completed",
          "result": {
            "status": "ok",
            "notes": "",
            "artifact_url": null,
            "artifact_checksum": null
          },
          "error_code": null,
          "error_message": null,
          "timestamp": "2025-11-22T12:00:10Z"
        },
        "response": {
          "status": "received",
          "audit_id": "AUD-999"
        }
      }
    }
  }
}
