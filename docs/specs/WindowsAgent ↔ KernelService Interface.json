{
  "AgentKernelInterface": {
    "version": "1.0",
    "purpose": "Defines the complete, strict request/response data model between WindowsAgent (user mode) and KernelService (privileged kernel mode).",

    "RequestSchema": {
      "description": "All IOCTL requests from Agent to KernelService must follow this schema.",
      "fields": {
        "request_id": "UUID (unique per kernel invocation)",
        "timestamp": "ISO8601 UTC timestamp",
        "opcode": "Enumerated string; must match AllowedOpcodes",
        "params": "Object; validated per-opcode",
        "agent_sequence": "Integer; strictly increasing counter from agent",
        "policy_hash": "SHA256 of active policy bundle",
        "command_message_id": "UUID linking to upper-layer command",
        "signature": "Ed25519 signature over canonical JSON of full request"
      }
    },

    "ResponseSchema": {
      "description": "All KernelService responses to the Agent must follow this format.",
      "fields": {
        "request_id": "UUID (mirrors request)",
        "status": "String enum: executing|ok|failed|denied|invalid_opcode",
        "kernel_exec_id": "UUID for kernel execution context",
        "timestamp": "ISO8601 UTC timestamp",
        "error_code": "Integer or null",
        "error_message": "Sanitized string or null",
        "result": "Object; opcode-dependent result payload",
        "signature": "Ed25519 signature created by KernelService"
      }
    },

    "AllowedOpcodes": {
      "SystemControl": [
        {
          "opcode": "EXEC_LOCK_SCREEN",
          "params_schema": {}
        },
        {
          "opcode": "EXEC_REBOOT",
          "params_schema": {
            "delay_seconds": "integer >= 0"
          }
        },
        {
          "opcode": "EXEC_SHUTDOWN",
          "params_schema": {
            "force": "boolean"
          }
        },
        {
          "opcode": "EXEC_LOGOUT",
          "params_schema": {}
        }
      ],
      "AgentInternal": [
        {
          "opcode": "EXEC_COLLECT_SYSTEM_INFO",
          "params_schema": {
            "fields": "array of strings"
          }
        },
        {
          "opcode": "EXEC_GET_PROCESS_LIST",
          "params_schema": {
            "include_cmdline": "boolean"
          }
        },
        {
          "opcode": "EXEC_PING_KERNEL",
          "params_schema": {}
        },
        {
          "opcode": "EXEC_VALIDATE_UPDATE_PACKAGE",
          "params_schema": {
            "path": "string (absolute file path)"
          }
        }
      ],
      "UpdateAndStaging": [
        {
          "opcode": "STAGE_UPDATE",
          "params_schema": {
            "package_path": "string",
            "flags": {
              "sandbox": "boolean"
            }
          }
        },
        {
          "opcode": "COMMIT_UPDATE",
          "params_schema": {
            "sandbox_id": "UUID"
          }
        },
        {
          "opcode": "ROLLBACK_UPDATE",
          "params_schema": {
            "snapshot_id": "UUID"
          }
        }
      ],
      "SecurityIntegrity": [
        {
          "opcode": "EXEC_RUN_ATTESTATION",
          "params_schema": {
            "include_tpm": "boolean"
          }
        },
        {
          "opcode": "EXEC_RUN_TAMPER_CHECK",
          "params_schema": {}
        },
        {
          "opcode": "EXEC_SELF_REPAIR",
          "params_schema": {}
        }
      ]
    },

    "KernelErrorCodes": {
      "0": "SUCCESS",
      "1001": "NET_TIMEOUT",
      "2001": "SIGNATURE_INVALID",
      "2002": "CERT_EXPIRED",
      "3001": "TAMPER_DETECTED",
      "4001": "DISK_FULL",
      "4002": "INVALID_OPCODE",
      "4003": "INVALID_PARAMS",
      "5001": "UPDATE_FAILURE",
      "9000": "INTERNAL_ERROR"
    },

    "BehavioralContract": {
      "AgentMust": [
        "Send only canonical JSON structures.",
        "Sign every request with Ed25519 private key.",
        "Increment agent_sequence for every IOCTL.",
        "Validate policy before calling kernel.",
        "Never retry kernel failures blindly.",
        "Use only documented opcodes."
      ],
      "KernelMust": [
        "Accept only known opcodes.",
        "Validate request signature.",
        "Validate all parameters.",
        "Return signed responses only.",
        "Never include sensitive OS internals in errors.",
        "Fail safely and deterministically."
      ]
    },

    "Examples": {
      "LockScreen": {
        "request": {
          "request_id": "req-111",
          "timestamp": "2025-11-22T12:00:00Z",
          "opcode": "EXEC_LOCK_SCREEN",
          "params": {},
          "agent_sequence": 9,
          "policy_hash": "abc123",
          "command_message_id": "CMD-0001",
          "signature": "sig_agent"
        },
        "response": {
          "request_id": "req-111",
          "status": "ok",
          "kernel_exec_id": "kexec-789",
          "timestamp": "2025-11-22T12:00:00Z",
          "error_code": null,
          "error_message": null,
          "result": {},
          "signature": "sig_kernel"
        }
      },

      "OTAStagingFailure": {
        "request": {
          "request_id": "req-222",
          "timestamp": "2025-11-22T12:05:00Z",
          "opcode": "STAGE_UPDATE",
          "params": {
            "package_path": "C:\\agent\\staging\\update.bin",
            "flags": {
              "sandbox": true
            }
          },
          "agent_sequence": 10,
          "policy_hash": "abc123",
          "command_message_id": "CMD-0002",
          "signature": "sig_agent"
        },
        "response": {
          "request_id": "req-222",
          "status": "failed",
          "kernel_exec_id": "kexec-790",
          "timestamp": "2025-11-22T12:05:01Z",
          "error_code": 4001,
          "error_message": "DISK_FULL",
          "result": {},
          "signature": "sig_kernel"
        }
      },

      "AttestationRun": {
        "request": {
          "request_id": "req-333",
          "timestamp": "2025-11-22T12:06:00Z",
          "opcode": "EXEC_RUN_ATTESTATION",
          "params": {
            "include_tpm": true
          },
          "agent_sequence": 11,
          "policy_hash": "abc123",
          "command_message_id": "CMD-0003",
          "signature": "sig_agent"
        },
        "response": {
          "request_id": "req-333",
          "status": "ok",
          "kernel_exec_id": "kexec-791",
          "timestamp": "2025-11-22T12:06:02Z",
          "error_code": null,
          "error_message": null,
          "result": {
            "agent_hash": "sha256:aaa...",
            "kernelservice_hash": "sha256:bbb...",
            "tpm_quote": "base64-blob"
          },
          "signature": "sig_kernel"
        }
      }
    }
  }
}
