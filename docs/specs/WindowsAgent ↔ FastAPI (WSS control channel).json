{
  "AgentFastAPIInterface": {
    "version": "1.0",
    "purpose": "Defines the complete request/response data model over a persistent WSS channel between WindowsAgent and FastAPI Controller.",
    "notes": [
      "This spec is only about the Agent â†” FastAPI WebSocket protocol.",
      "Higher layers (Laravel, Mobile, KernelService) are out of scope here.",
      "All messages are JSON, framed over a TLS 1.3 WebSocket connection."
    ],

    "ConnectionModel": {
      "ws_url_example": "wss://controller.example.com/agent",
      "auth_flow_summary": [
        "1. Agent establishes TLS connection.",
        "2. Agent sends AUTH message as first frame.",
        "3. FastAPI validates credentials and returns AUTH_ACK or AUTH_ERROR.",
        "4. Only after AUTH_ACK may other message types be exchanged."
      ],
      "session": {
        "session_id": "UUID assigned by FastAPI on successful auth",
        "reconnect_behavior": "Agent reuses device_id and performs AUTH again; FastAPI may map to previous session_id or issue new ID."
      }
    },

    "CommonEnvelope": {
      "description": "All messages share a common envelope plus a type-specific body.",
      "schema": {
        "message_id": "UUID (unique per message)",
        "timestamp": "ISO8601 UTC timestamp",
        "type": "Enumerated string (see MessageTypes.type)",
        "from": "agent|controller",
        "device_id": "string (Agent's logical id, e.g. PC001)",
        "session_id": "string or null (set after auth)",
        "body": "Object; structure depends on type",
        "sig": "string; Ed25519 signature over canonical JSON of the entire message (excluding sig field)"
      }
    },

    "MessageTypes": {
      "list": [
        "AUTH",
        "AUTH_ACK",
        "AUTH_ERROR",
        "HEARTBEAT",
        "TELEMETRY",
        "COMMAND_DELIVERY",
        "COMMAND_ACK",
        "COMMAND_RESULT",
        "UPDATE_ANNOUNCE",
        "UPDATE_STATUS",
        "POLICY_UPDATE",
        "ALERT",
        "ERROR"
      ],
      "direction": {
        "AgentToController": [
          "AUTH",
          "HEARTBEAT",
          "TELEMETRY",
          "COMMAND_ACK",
          "COMMAND_RESULT",
          "UPDATE_STATUS"
        ],
        "ControllerToAgent": [
          "AUTH_ACK",
          "AUTH_ERROR",
          "COMMAND_DELIVERY",
          "UPDATE_ANNOUNCE",
          "POLICY_UPDATE",
          "ALERT",
          "ERROR"
        ]
      }
    },

    "Schemas": {
      "AUTH": {
        "direction": "AgentToController",
        "description": "Initial authentication and session establishment from Agent.",
        "body_schema": {
          "auth": {
            "jwt": "short-lived agent JWT issued by backend auth/CA",
            "nonce": "monotonic or random nonce to prevent replay"
          },
          "agent_info": {
            "agent_version": "string (e.g. 2.0.1)",
            "os_build": "string (e.g. 19045)",
            "hwid_hash": "sha256(HWID)",
            "attestation_hash": "optional string; last-known good agent+kernel hash"
          }
        },
        "example": {
          "message_id": "m-auth-001",
          "timestamp": "2025-11-22T12:00:00Z",
          "type": "AUTH",
          "from": "agent",
          "device_id": "PC001",
          "session_id": null,
          "body": {
            "auth": {
              "jwt": "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9....",
              "nonce": "123456789"
            },
            "agent_info": {
              "agent_version": "2.0.1",
              "os_build": "19045",
              "hwid_hash": "sha256:abc...",
              "attestation_hash": "sha256:def..."
            }
          },
          "sig": "sig_agent_over_auth"
        }
      },

      "AUTH_ACK": {
        "direction": "ControllerToAgent",
        "description": "Sent by FastAPI when AUTH is successful.",
        "body_schema": {
          "status": "string; always 'ok' for AUTH_ACK",
          "session_id": "UUID; assigned controller session id",
          "heartbeat_interval_seconds": "integer (e.g. 30)",
          "telemetry_interval_seconds": "integer (e.g. 60)",
          "policy_hash": "sha256 of current policy bundle known by controller"
        },
        "example": {
          "message_id": "m-auth-ack-001",
          "timestamp": "2025-11-22T12:00:01Z",
          "type": "AUTH_ACK",
          "from": "controller",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "status": "ok",
            "session_id": "sess-789",
            "heartbeat_interval_seconds": 30,
            "telemetry_interval_seconds": 60,
            "policy_hash": "sha256:policy123"
          },
          "sig": "sig_controller_auth_ack"
        }
      },

      "AUTH_ERROR": {
        "direction": "ControllerToAgent",
        "description": "Sent by FastAPI if AUTH fails.",
        "body_schema": {
          "status": "string; 'error'",
          "error_code": "string (e.g. AUTH_INVALID_JWT | AUTH_EXPIRED | AUTH_REVOKED)",
          "error_message": "short, non-sensitive error description"
        },
        "example": {
          "message_id": "m-auth-err-001",
          "timestamp": "2025-11-22T12:00:01Z",
          "type": "AUTH_ERROR",
          "from": "controller",
          "device_id": "PC001",
          "session_id": null,
          "body": {
            "status": "error",
            "error_code": "AUTH_INVALID_JWT",
            "error_message": "JWT signature invalid or expired."
          },
          "sig": "sig_controller_auth_error"
        }
      },

      "HEARTBEAT": {
        "direction": "AgentToController",
        "description": "Periodic liveness signal sent from Agent.",
        "body_schema": {
          "status": "string; 'alive'",
          "uptime_seconds": "integer; optional agent uptime",
          "error_state": "optional string; e.g. 'ok' or brief summary"
        },
        "example": {
          "message_id": "m-hb-001",
          "timestamp": "2025-11-22T12:01:00Z",
          "type": "HEARTBEAT",
          "from": "agent",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "status": "alive",
            "uptime_seconds": 3600,
            "error_state": "ok"
          },
          "sig": "sig_agent_heartbeat"
        }
      },

      "TELEMETRY": {
        "direction": "AgentToController",
        "description": "Periodic telemetry sample from Agent.",
        "body_schema": {
          "timestamp": "ISO8601 timestamp of sample",
          "metrics": {
            "cpu": "string; percentage e.g. '12%'",
            "ram": "string; percentage e.g. '45%'",
            "disk_usage": "string; percentage e.g. '60%'",
            "network_tx": "string; e.g. '2.3Mbps'",
            "network_rx": "string; e.g. '1.8Mbps'"
          },
          "telemetry_scope": "string; e.g. 'telemetry_basic'"
        },
        "example": {
          "message_id": "m-tel-001",
          "timestamp": "2025-11-22T12:02:00Z",
          "type": "TELEMETRY",
          "from": "agent",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "timestamp": "2025-11-22T12:02:00Z",
            "metrics": {
              "cpu": "12%",
              "ram": "45%",
              "disk_usage": "60%",
              "network_tx": "2.3Mbps",
              "network_rx": "1.8Mbps"
            },
            "telemetry_scope": "telemetry_basic"
          },
          "sig": "sig_agent_telemetry"
        }
      },

      "COMMAND_DELIVERY": {
        "direction": "ControllerToAgent",
        "description": "Controller pushing a command envelope to the Agent for execution.",
        "body_schema": {
          "command_envelope": {
            "message_id": "UUID (command id)",
            "trace_id": "UUID",
            "seq": "integer sequence for this device",
            "header": {
              "version": "string; e.g. '1.1'",
              "timestamp": "ISO8601",
              "ttl_seconds": "integer",
              "priority": "string; 'normal|high'",
              "requires_ack": "boolean",
              "long_running": "boolean"
            },
            "body": {
              "method": "string; must be known command_name",
              "params": "object; method-specific parameters",
              "sensitive": "boolean"
            },
            "meta": {
              "device_id": "string; e.g. 'PC001'",
              "origin_user_id": "string; user id from backend",
              "enc": "string; 'none|aes256gcm'",
              "enc_key_id": "optional string; key identifier",
              "policy_version": "string; e.g. 'policy-2025-10-29'"
            },
            "sig": "string; controller signature over canonical envelope"
          }
        },
        "example": {
          "message_id": "m-cmd-delivery-001",
          "timestamp": "2025-11-22T12:03:00Z",
          "type": "COMMAND_DELIVERY",
          "from": "controller",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "command_envelope": {
              "message_id": "CMD-0001-uuid",
              "trace_id": "TRACE-0001",
              "seq": 1,
              "header": {
                "version": "1.1",
                "timestamp": "2025-11-22T12:03:00Z",
                "ttl_seconds": 300,
                "priority": "normal",
                "requires_ack": true,
                "long_running": false
              },
              "body": {
                "method": "lock_screen",
                "params": {},
                "sensitive": false
              },
              "meta": {
                "device_id": "PC001",
                "origin_user_id": "UID001",
                "enc": "none",
                "enc_key_id": null,
                "policy_version": "policy-2025-10-29"
              },
              "sig": "sig_controller_over_envelope"
            }
          },
          "sig": "sig_controller_outer"
        }
      },

      "COMMAND_ACK": {
        "direction": "AgentToController",
        "description": "Agent acknowledges receipt (not execution) of a COMMAND_DELIVERY.",
        "body_schema": {
          "command_message_id": "UUID; mirrors command_envelope.message_id",
          "status": "string; 'received' or 'rejected'",
          "reason": "optional string; if rejected (e.g. 'unknown_method', 'policy_denied', 'expired_ttl')"
        },
        "example": {
          "message_id": "m-cmd-ack-001",
          "timestamp": "2025-11-22T12:03:01Z",
          "type": "COMMAND_ACK",
          "from": "agent",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "command_message_id": "CMD-0001-uuid",
            "status": "received",
            "reason": null
          },
          "sig": "sig_agent_cmd_ack"
        }
      },

      "COMMAND_RESULT": {
        "direction": "AgentToController",
        "description": "Execution result or partial result (for long running) of a command.",
        "body_schema": {
          "command_message_id": "UUID; command id",
          "execution_state": "string; 'completed|failed|executing|partial'",
          "result": {
            "status": "string; 'ok|error'",
            "notes": "optional string",
            "artifact_url": "optional string; if large artifact stored in ObjectStore",
            "artifact_checksum": "optional string"
          },
          "error_code": "optional integer; if failed",
          "error_message": "optional string"
        },
        "example": {
          "message_id": "m-cmd-res-001",
          "timestamp": "2025-11-22T12:03:10Z",
          "type": "COMMAND_RESULT",
          "from": "agent",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "command_message_id": "CMD-0001-uuid",
            "execution_state": "completed",
            "result": {
              "status": "ok",
              "notes": "",
              "artifact_url": null,
              "artifact_checksum": null
            },
            "error_code": null,
            "error_message": null
          },
          "sig": "sig_agent_cmd_result"
        }
      },

      "UPDATE_ANNOUNCE": {
        "direction": "ControllerToAgent",
        "description": "Notify Agent that an update is available.",
        "body_schema": {
          "release_id": "string; e.g. 'rel-2025-10-29-001'",
          "version": "string; e.g. '2.0.1'",
          "manifest_url": "string; HTTPS URL to manifest",
          "signature_url": "string; HTTPS URL to detached signature",
          "sha256": "string; expected package hash",
          "min_os_build": "string",
          "policy": {
            "auto_install": "boolean",
            "allow_reboot": "boolean"
          }
        },
        "example": {
          "message_id": "m-upd-announce-001",
          "timestamp": "2025-11-22T12:04:00Z",
          "type": "UPDATE_ANNOUNCE",
          "from": "controller",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "release_id": "rel-2025-10-29-001",
            "version": "2.0.1",
            "manifest_url": "https://objectstore/updates/rel-2025-10-29-001/manifest.json",
            "signature_url": "https://objectstore/updates/rel-2025-10-29-001/manifest.json.sig",
            "sha256": "sha256:abcdef...",
            "min_os_build": "19041",
            "policy": {
              "auto_install": false,
              "allow_reboot": true
            }
          },
          "sig": "sig_controller_update_announce"
        }
      },

      "UPDATE_STATUS": {
        "direction": "AgentToController",
        "description": "Agent reporting progress or final result of an update.",
        "body_schema": {
          "release_id": "string",
          "version": "string",
          "phase": "string; 'precheck|downloading|verifying|staged|committing|rebooting|success|failed|rolled_back'",
          "progress": {
            "percent": "integer 0-100",
            "detail": "optional string"
          },
          "error_code": "optional integer",
          "error_message": "optional string",
          "rollback_snapshot_id": "optional string"
        },
        "example": {
          "message_id": "m-upd-status-001",
          "timestamp": "2025-11-22T12:04:30Z",
          "type": "UPDATE_STATUS",
          "from": "agent",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "release_id": "rel-2025-10-29-001",
            "version": "2.0.1",
            "phase": "downloading",
            "progress": {
              "percent": 25,
              "detail": "4 of 16 parts downloaded"
            },
            "error_code": null,
            "error_message": null,
            "rollback_snapshot_id": null
          },
          "sig": "sig_agent_update_status"
        }
      },

      "POLICY_UPDATE": {
        "direction": "ControllerToAgent",
        "description": "Broadcast updated policy bundle to Agent.",
        "body_schema": {
          "policy_version": "string; e.g. 'policy-2025-11-01'",
          "policy_hash": "sha256 of rules bundle",
          "policy_url": "string; HTTPS URL to encrypted policy bundle (if large)",
          "effective_from": "ISO8601 timestamp"
        },
        "example": {
          "message_id": "m-policy-001",
          "timestamp": "2025-11-22T12:05:00Z",
          "type": "POLICY_UPDATE",
          "from": "controller",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "policy_version": "policy-2025-11-01",
            "policy_hash": "sha256:newpolicy123",
            "policy_url": "https://objectstore/policies/policy-2025-11-01.bundle",
            "effective_from": "2025-11-22T12:10:00Z"
          },
          "sig": "sig_controller_policy_update"
        }
      },

      "ALERT": {
        "direction": "ControllerToAgent",
        "description": "Controller pushing an alert (e.g. high-risk telemetry anomaly) that may require local UI action or local logging.",
        "body_schema": {
          "alert_id": "UUID",
          "severity": "string; 'info|warning|critical'",
          "category": "string; e.g. 'telemetry_anomaly|update_failure|policy_violation'",
          "message": "short human-readable string",
          "details": "optional object; additional structured data"
        },
        "example": {
          "message_id": "m-alert-001",
          "timestamp": "2025-11-22T12:06:00Z",
          "type": "ALERT",
          "from": "controller",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "alert_id": "alert-123",
            "severity": "critical",
            "category": "telemetry_anomaly",
            "message": "CPU sustained above 90% for 5 minutes",
            "details": {
              "avg_cpu": "92%",
              "window_minutes": 5
            }
          },
          "sig": "sig_controller_alert"
        }
      },

      "ERROR": {
        "direction": "ControllerToAgent OR AgentToController",
        "description": "Generic protocol-level error; not command-specific.",
        "body_schema": {
          "error_code": "string; e.g. 'PROTO_INVALID_MESSAGE' | 'UNSUPPORTED_TYPE'",
          "error_message": "short description",
          "related_message_id": "optional message_id reference",
          "retryable": "boolean; indicates if the sender may retry"
        },
        "example": {
          "message_id": "m-error-001",
          "timestamp": "2025-11-22T12:07:00Z",
          "type": "ERROR",
          "from": "controller",
          "device_id": "PC001",
          "session_id": "sess-789",
          "body": {
            "error_code": "PROTO_INVALID_MESSAGE",
            "error_message": "Missing required field 'body' for TELEMETRY.",
            "related_message_id": "m-tel-bad-123",
            "retryable": false
          },
          "sig": "sig_controller_error"
        }
      }
    },

    "BehavioralContract": {
      "AgentMust": [
        "Send AUTH as the first message in a new WSS connection.",
        "Wait for AUTH_ACK before sending any HEARTBEAT, TELEMETRY, COMMAND_ACK or COMMAND_RESULT.",
        "Sign all messages with its device private key.",
        "Respect heartbeat_interval_seconds provided in AUTH_ACK.",
        "Reject COMMAND_DELIVERY messages whose inner command_envelope signature or TTL is invalid.",
        "Emit COMMAND_ACK promptly after receiving a valid COMMAND_DELIVERY."
      ],
      "ControllerMust": [
        "Close the connection or send AUTH_ERROR if AUTH validation fails.",
        "Only treat the Agent as online if periodic HEARTBEAT messages are received.",
        "Validate signature and schema for every Agent message; discard invalid ones and optionally send ERROR.",
        "Use COMMAND_DELIVERY only for commands already authorized at server-side policy layer.",
        "Send UPDATE_ANNOUNCE and POLICY_UPDATE only for this device_id and tenant context.",
        "Ensure ALERT messages contain no sensitive or identifying user data beyond what is necessary."
      ]
    }
  }
}
