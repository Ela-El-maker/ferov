{
  "MasterBlueprint": {
    "version": "3.0",
    "project": "Secure Device Control System - Full Interface Spec",
    "scope": "End-to-end request/response and protocol data models only (no implementation).",

    "Interfaces": {
      "AgentKernelInterface": {
        "version": "1.0",
        "purpose": "Defines the complete, strict request/response data model between WindowsAgent (user mode) and KernelService (privileged kernel mode).",

        "RequestSchema": {
          "description": "All IOCTL requests from Agent to KernelService must follow this schema.",
          "fields": {
            "request_id": "UUID (unique per kernel invocation)",
            "timestamp": "ISO8601 UTC timestamp",
            "opcode": "Enumerated string; must match AllowedOpcodes",
            "params": "Object; validated per-opcode",
            "agent_sequence": "Integer; strictly increasing counter from agent",
            "policy_hash": "SHA256 of active policy bundle",
            "command_message_id": "UUID linking to upper-layer command",
            "signature": "Ed25519 signature over canonical JSON of full request"
          }
        },

        "ResponseSchema": {
          "description": "All KernelService responses to the Agent must follow this format.",
          "fields": {
            "request_id": "UUID (mirrors request)",
            "status": "String enum: executing|ok|failed|denied|invalid_opcode",
            "kernel_exec_id": "UUID for kernel execution context",
            "timestamp": "ISO8601 UTC timestamp",
            "error_code": "Integer or null",
            "error_message": "Sanitized string or null",
            "result": "Object; opcode-dependent result payload",
            "signature": "Ed25519 signature created by KernelService"
          }
        },

        "AllowedOpcodes": {
          "SystemControl": [
            {
              "opcode": "EXEC_LOCK_SCREEN",
              "params_schema": {}
            },
            {
              "opcode": "EXEC_REBOOT",
              "params_schema": {
                "delay_seconds": "integer >= 0"
              }
            },
            {
              "opcode": "EXEC_SHUTDOWN",
              "params_schema": {
                "force": "boolean"
              }
            },
            {
              "opcode": "EXEC_LOGOUT",
              "params_schema": {}
            }
          ],
          "AgentInternal": [
            {
              "opcode": "EXEC_COLLECT_SYSTEM_INFO",
              "params_schema": {
                "fields": "array of strings"
              }
            },
            {
              "opcode": "EXEC_GET_PROCESS_LIST",
              "params_schema": {
                "include_cmdline": "boolean"
              }
            },
            {
              "opcode": "EXEC_PING_KERNEL",
              "params_schema": {}
            },
            {
              "opcode": "EXEC_VALIDATE_UPDATE_PACKAGE",
              "params_schema": {
                "path": "string (absolute file path)"
              }
            }
          ],
          "UpdateAndStaging": [
            {
              "opcode": "STAGE_UPDATE",
              "params_schema": {
                "package_path": "string",
                "flags": {
                  "sandbox": "boolean"
                }
              }
            },
            {
              "opcode": "COMMIT_UPDATE",
              "params_schema": {
                "sandbox_id": "UUID"
              }
            },
            {
              "opcode": "ROLLBACK_UPDATE",
              "params_schema": {
                "snapshot_id": "UUID"
              }
            }
          ],
          "SecurityIntegrity": [
            {
              "opcode": "EXEC_RUN_ATTESTATION",
              "params_schema": {
                "include_tpm": "boolean"
              }
            },
            {
              "opcode": "EXEC_RUN_TAMPER_CHECK",
              "params_schema": {}
            },
            {
              "opcode": "EXEC_SELF_REPAIR",
              "params_schema": {}
            }
          ]
        },

        "KernelErrorCodes": {
          "0": "SUCCESS",
          "1001": "NET_TIMEOUT",
          "2001": "SIGNATURE_INVALID",
          "2002": "CERT_EXPIRED",
          "3001": "TAMPER_DETECTED",
          "4001": "DISK_FULL",
          "4002": "INVALID_OPCODE",
          "4003": "INVALID_PARAMS",
          "5001": "UPDATE_FAILURE",
          "9000": "INTERNAL_ERROR"
        },

        "BehavioralContract": {
          "AgentMust": [
            "Send only canonical JSON structures.",
            "Sign every request with Ed25519 private key.",
            "Increment agent_sequence for every IOCTL.",
            "Validate policy before calling kernel.",
            "Never retry kernel failures blindly.",
            "Use only documented opcodes."
          ],
          "KernelMust": [
            "Accept only known opcodes.",
            "Validate request signature.",
            "Validate all parameters.",
            "Return signed responses only.",
            "Never include sensitive OS internals in errors.",
            "Fail safely and deterministically."
          ]
        },

        "Examples": {
          "LockScreen": {
            "request": {
              "request_id": "req-111",
              "timestamp": "2025-11-22T12:00:00Z",
              "opcode": "EXEC_LOCK_SCREEN",
              "params": {},
              "agent_sequence": 9,
              "policy_hash": "abc123",
              "command_message_id": "CMD-0001",
              "signature": "sig_agent"
            },
            "response": {
              "request_id": "req-111",
              "status": "ok",
              "kernel_exec_id": "kexec-789",
              "timestamp": "2025-11-22T12:00:00Z",
              "error_code": null,
              "error_message": null,
              "result": {},
              "signature": "sig_kernel"
            }
          },

          "OTAStagingFailure": {
            "request": {
              "request_id": "req-222",
              "timestamp": "2025-11-22T12:05:00Z",
              "opcode": "STAGE_UPDATE",
              "params": {
                "package_path": "C:\\agent\\staging\\update.bin",
                "flags": {
                  "sandbox": true
                }
              },
              "agent_sequence": 10,
              "policy_hash": "abc123",
              "command_message_id": "CMD-0002",
              "signature": "sig_agent"
            },
            "response": {
              "request_id": "req-222",
              "status": "failed",
              "kernel_exec_id": "kexec-790",
              "timestamp": "2025-11-22T12:05:01Z",
              "error_code": 4001,
              "error_message": "DISK_FULL",
              "result": {},
              "signature": "sig_kernel"
            }
          },

          "AttestationRun": {
            "request": {
              "request_id": "req-333",
              "timestamp": "2025-11-22T12:06:00Z",
              "opcode": "EXEC_RUN_ATTESTATION",
              "params": {
                "include_tpm": true
              },
              "agent_sequence": 11,
              "policy_hash": "abc123",
              "command_message_id": "CMD-0003",
              "signature": "sig_agent"
            },
            "response": {
              "request_id": "req-333",
              "status": "ok",
              "kernel_exec_id": "kexec-791",
              "timestamp": "2025-11-22T12:06:02Z",
              "error_code": null,
              "error_message": null,
              "result": {
                "agent_hash": "sha256:aaa...",
                "kernelservice_hash": "sha256:bbb...",
                "tpm_quote": "base64-blob"
              },
              "signature": "sig_kernel"
            }
          }
        }
      },

      "AgentFastAPIInterface": {
        "version": "1.0",
        "purpose": "Defines the complete request/response data model over a persistent WSS channel between WindowsAgent and FastAPI Controller.",
        "notes": [
          "This spec is only about the Agent ↔ FastAPI WebSocket protocol.",
          "All messages are JSON, framed over a TLS 1.3 WebSocket connection."
        ],

        "ConnectionModel": {
          "ws_url_example": "wss://controller.example.com/agent",
          "auth_flow_summary": [
            "1. Agent establishes TLS connection.",
            "2. Agent sends AUTH message as first frame.",
            "3. FastAPI validates credentials and returns AUTH_ACK or AUTH_ERROR.",
            "4. Only after AUTH_ACK may other message types be exchanged."
          ],
          "session": {
            "session_id": "UUID assigned by FastAPI on successful auth",
            "reconnect_behavior": "Agent reuses device_id and performs AUTH again; FastAPI may map to previous session_id or issue new ID."
          }
        },

        "CommonEnvelope": {
          "description": "All messages share a common envelope plus a type-specific body.",
          "schema": {
            "message_id": "UUID (unique per message)",
            "timestamp": "ISO8601 UTC timestamp",
            "type": "Enumerated string (see MessageTypes.type)",
            "from": "agent|controller",
            "device_id": "string (Agent's logical id, e.g. PC001)",
            "session_id": "string or null (set after auth)",
            "body": "Object; structure depends on type",
            "sig": "string; Ed25519 signature over canonical JSON of the entire message (excluding sig field)"
          }
        },

        "MessageTypes": {
          "list": [
            "AUTH",
            "AUTH_ACK",
            "AUTH_ERROR",
            "HEARTBEAT",
            "TELEMETRY",
            "COMMAND_DELIVERY",
            "COMMAND_ACK",
            "COMMAND_RESULT",
            "UPDATE_ANNOUNCE",
            "UPDATE_STATUS",
            "POLICY_UPDATE",
            "ALERT",
            "ERROR"
          ],
          "direction": {
            "AgentToController": [
              "AUTH",
              "HEARTBEAT",
              "TELEMETRY",
              "COMMAND_ACK",
              "COMMAND_RESULT",
              "UPDATE_STATUS"
            ],
            "ControllerToAgent": [
              "AUTH_ACK",
              "AUTH_ERROR",
              "COMMAND_DELIVERY",
              "UPDATE_ANNOUNCE",
              "POLICY_UPDATE",
              "ALERT",
              "ERROR"
            ]
          }
        },

        "Schemas": {
          "AUTH": {
            "direction": "AgentToController",
            "description": "Initial authentication and session establishment from Agent.",
            "body_schema": {
              "auth": {
                "jwt": "short-lived agent JWT issued by backend auth/CA",
                "nonce": "monotonic or random nonce to prevent replay"
              },
              "agent_info": {
                "agent_version": "string (e.g. 2.0.1)",
                "os_build": "string (e.g. 19045)",
                "hwid_hash": "sha256(HWID)",
                "attestation_hash": "optional string; last-known good agent+kernel hash"
              }
            },
            "example": {
              "message_id": "m-auth-001",
              "timestamp": "2025-11-22T12:00:00Z",
              "type": "AUTH",
              "from": "agent",
              "device_id": "PC001",
              "session_id": null,
              "body": {
                "auth": {
                  "jwt": "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9....",
                  "nonce": "123456789"
                },
                "agent_info": {
                  "agent_version": "2.0.1",
                  "os_build": "19045",
                  "hwid_hash": "sha256:abc...",
                  "attestation_hash": "sha256:def..."
                }
              },
              "sig": "sig_agent_over_auth"
            }
          },

          "AUTH_ACK": {
            "direction": "ControllerToAgent",
            "description": "Sent by FastAPI when AUTH is successful.",
            "body_schema": {
              "status": "string; always 'ok' for AUTH_ACK",
              "session_id": "UUID; assigned controller session id",
              "heartbeat_interval_seconds": "integer (e.g. 30)",
              "telemetry_interval_seconds": "integer (e.g. 60)",
              "policy_hash": "sha256 of current policy bundle known by controller"
            },
            "example": {
              "message_id": "m-auth-ack-001",
              "timestamp": "2025-11-22T12:00:01Z",
              "type": "AUTH_ACK",
              "from": "controller",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "status": "ok",
                "session_id": "sess-789",
                "heartbeat_interval_seconds": 30,
                "telemetry_interval_seconds": 60,
                "policy_hash": "sha256:policy123"
              },
              "sig": "sig_controller_auth_ack"
            }
          },

          "AUTH_ERROR": {
            "direction": "ControllerToAgent",
            "description": "Sent by FastAPI if AUTH fails.",
            "body_schema": {
              "status": "string; 'error'",
              "error_code": "string (e.g. AUTH_INVALID_JWT | AUTH_EXPIRED | AUTH_REVOKED)",
              "error_message": "short, non-sensitive error description"
            },
            "example": {
              "message_id": "m-auth-err-001",
              "timestamp": "2025-11-22T12:00:01Z",
              "type": "AUTH_ERROR",
              "from": "controller",
              "device_id": "PC001",
              "session_id": null,
              "body": {
                "status": "error",
                "error_code": "AUTH_INVALID_JWT",
                "error_message": "JWT signature invalid or expired."
              },
              "sig": "sig_controller_auth_error"
            }
          },

          "HEARTBEAT": {
            "direction": "AgentToController",
            "description": "Periodic liveness signal sent from Agent.",
            "body_schema": {
              "status": "string; 'alive'",
              "uptime_seconds": "integer; optional agent uptime",
              "error_state": "optional string; e.g. 'ok' or brief summary"
            },
            "example": {
              "message_id": "m-hb-001",
              "timestamp": "2025-11-22T12:01:00Z",
              "type": "HEARTBEAT",
              "from": "agent",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "status": "alive",
                "uptime_seconds": 3600,
                "error_state": "ok"
              },
              "sig": "sig_agent_heartbeat"
            }
          },

          "TELEMETRY": {
            "direction": "AgentToController",
            "description": "Periodic telemetry sample from Agent.",
            "body_schema": {
              "timestamp": "ISO8601 timestamp of sample",
              "metrics": {
                "cpu": "string; percentage e.g. '12%'",
                "ram": "string; percentage e.g. '45%'",
                "disk_usage": "string; percentage e.g. '60%'",
                "network_tx": "string; e.g. '2.3Mbps'",
                "network_rx": "string; e.g. '1.8Mbps'"
              },
              "telemetry_scope": "string; e.g. 'telemetry_basic'"
            },
            "example": {
              "message_id": "m-tel-001",
              "timestamp": "2025-11-22T12:02:00Z",
              "type": "TELEMETRY",
              "from": "agent",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "timestamp": "2025-11-22T12:02:00Z",
                "metrics": {
                  "cpu": "12%",
                  "ram": "45%",
                  "disk_usage": "60%",
                  "network_tx": "2.3Mbps",
                  "network_rx": "1.8Mbps"
                },
                "telemetry_scope": "telemetry_basic"
              },
              "sig": "sig_agent_telemetry"
            }
          },

          "COMMAND_DELIVERY": {
            "direction": "ControllerToAgent",
            "description": "Controller pushing a command envelope to the Agent for execution.",
            "body_schema": {
              "command_envelope": {
                "message_id": "UUID (command id)",
                "trace_id": "UUID",
                "seq": "integer sequence for this device",
                "header": {
                  "version": "string; e.g. '1.1'",
                  "timestamp": "ISO8601",
                  "ttl_seconds": "integer",
                  "priority": "string; 'normal|high'",
                  "requires_ack": "boolean",
                  "long_running": "boolean"
                },
                "body": {
                  "method": "string; must be known command_name",
                  "params": "object; method-specific parameters",
                  "sensitive": "boolean"
                },
                "meta": {
                  "device_id": "string; e.g. 'PC001'",
                  "origin_user_id": "string; user id from backend",
                  "enc": "string; 'none|aes256gcm'",
                  "enc_key_id": "optional string; key identifier",
                  "policy_version": "string; e.g. 'policy-2025-10-29'"
                },
                "sig": "string; controller signature over canonical envelope"
              }
            },
            "example": {
              "message_id": "m-cmd-delivery-001",
              "timestamp": "2025-11-22T12:03:00Z",
              "type": "COMMAND_DELIVERY",
              "from": "controller",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "command_envelope": {
                  "message_id": "CMD-0001-uuid",
                  "trace_id": "TRACE-0001",
                  "seq": 1,
                  "header": {
                    "version": "1.1",
                    "timestamp": "2025-11-22T12:03:00Z",
                    "ttl_seconds": 300,
                    "priority": "normal",
                    "requires_ack": true,
                    "long_running": false
                  },
                  "body": {
                    "method": "lock_screen",
                    "params": {},
                    "sensitive": false
                  },
                  "meta": {
                    "device_id": "PC001",
                    "origin_user_id": "UID001",
                    "enc": "none",
                    "enc_key_id": null,
                    "policy_version": "policy-2025-10-29"
                  },
                  "sig": "sig_controller_over_envelope"
                }
              },
              "sig": "sig_controller_outer"
            }
          },

          "COMMAND_ACK": {
            "direction": "AgentToController",
            "description": "Agent acknowledges receipt (not execution) of a COMMAND_DELIVERY.",
            "body_schema": {
              "command_message_id": "UUID; mirrors command_envelope.message_id",
              "status": "string; 'received' or 'rejected'",
              "reason": "optional string; if rejected (e.g. 'unknown_method', 'policy_denied', 'expired_ttl')"
            },
            "example": {
              "message_id": "m-cmd-ack-001",
              "timestamp": "2025-11-22T12:03:01Z",
              "type": "COMMAND_ACK",
              "from": "agent",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "command_message_id": "CMD-0001-uuid",
                "status": "received",
                "reason": null
              },
              "sig": "sig_agent_cmd_ack"
            }
          },

          "COMMAND_RESULT": {
            "direction": "AgentToController",
            "description": "Execution result or partial result (for long running) of a command.",
            "body_schema": {
              "command_message_id": "UUID; command id",
              "execution_state": "string; 'completed|failed|executing|partial'",
              "result": {
                "status": "string; 'ok|error'",
                "notes": "optional string",
                "artifact_url": "optional string; if large artifact stored in ObjectStore",
                "artifact_checksum": "optional string"
              },
              "error_code": "optional integer; if failed",
              "error_message": "optional string"
            },
            "example": {
              "message_id": "m-cmd-res-001",
              "timestamp": "2025-11-22T12:03:10Z",
              "type": "COMMAND_RESULT",
              "from": "agent",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "command_message_id": "CMD-0001-uuid",
                "execution_state": "completed",
                "result": {
                  "status": "ok",
                  "notes": "",
                  "artifact_url": null,
                  "artifact_checksum": null
                },
                "error_code": null,
                "error_message": null
              },
              "sig": "sig_agent_cmd_result"
            }
          },

          "UPDATE_ANNOUNCE": {
            "direction": "ControllerToAgent",
            "description": "Notify Agent that an update is available.",
            "body_schema": {
              "release_id": "string; e.g. 'rel-2025-10-29-001'",
              "version": "string; e.g. '2.0.1'",
              "manifest_url": "string; HTTPS URL to manifest",
              "signature_url": "string; HTTPS URL to detached signature",
              "sha256": "string; expected package hash",
              "min_os_build": "string",
              "policy": {
                "auto_install": "boolean",
                "allow_reboot": "boolean"
              }
            },
            "example": {
              "message_id": "m-upd-announce-001",
              "timestamp": "2025-11-22T12:04:00Z",
              "type": "UPDATE_ANNOUNCE",
              "from": "controller",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "release_id": "rel-2025-10-29-001",
                "version": "2.0.1",
                "manifest_url": "https://objectstore/updates/rel-2025-10-29-001/manifest.json",
                "signature_url": "https://objectstore/updates/rel-2025-10-29-001/manifest.json.sig",
                "sha256": "sha256:abcdef...",
                "min_os_build": "19041",
                "policy": {
                  "auto_install": false,
                  "allow_reboot": true
                }
              },
              "sig": "sig_controller_update_announce"
            }
          },

          "UPDATE_STATUS": {
            "direction": "AgentToController",
            "description": "Agent reporting progress or final result of an update.",
            "body_schema": {
              "release_id": "string",
              "version": "string",
              "phase": "string; 'precheck|downloading|verifying|staged|committing|rebooting|success|failed|rolled_back'",
              "progress": {
                "percent": "integer 0-100",
                "detail": "optional string"
              },
              "error_code": "optional integer",
              "error_message": "optional string",
              "rollback_snapshot_id": "optional string"
            },
            "example": {
              "message_id": "m-upd-status-001",
              "timestamp": "2025-11-22T12:04:30Z",
              "type": "UPDATE_STATUS",
              "from": "agent",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "release_id": "rel-2025-10-29-001",
                "version": "2.0.1",
                "phase": "downloading",
                "progress": {
                  "percent": 25,
                  "detail": "4 of 16 parts downloaded"
                },
                "error_code": null,
                "error_message": null,
                "rollback_snapshot_id": null
              },
              "sig": "sig_agent_update_status"
            }
          },

          "POLICY_UPDATE": {
            "direction": "ControllerToAgent",
            "description": "Broadcast updated policy bundle to Agent.",
            "body_schema": {
              "policy_version": "string; e.g. 'policy-2025-11-01'",
              "policy_hash": "sha256 of rules bundle",
              "policy_url": "string; HTTPS URL to encrypted policy bundle (if large)",
              "effective_from": "ISO8601 timestamp"
            },
            "example": {
              "message_id": "m-policy-001",
              "timestamp": "2025-11-22T12:05:00Z",
              "type": "POLICY_UPDATE",
              "from": "controller",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "policy_version": "policy-2025-11-01",
                "policy_hash": "sha256:newpolicy123",
                "policy_url": "https://objectstore/policies/policy-2025-11-01.bundle",
                "effective_from": "2025-11-22T12:10:00Z"
              },
              "sig": "sig_controller_policy_update"
            }
          },

          "ALERT": {
            "direction": "ControllerToAgent",
            "description": "Controller pushing an alert that may require local UI/logging action.",
            "body_schema": {
              "alert_id": "UUID",
              "severity": "string; 'info|warning|critical'",
              "category": "string; e.g. 'telemetry_anomaly|update_failure|policy_violation'",
              "message": "short human-readable string",
              "details": "optional object; additional structured data"
            },
            "example": {
              "message_id": "m-alert-001",
              "timestamp": "2025-11-22T12:06:00Z",
              "type": "ALERT",
              "from": "controller",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "alert_id": "alert-123",
                "severity": "critical",
                "category": "telemetry_anomaly",
                "message": "CPU sustained above 90% for 5 minutes",
                "details": {
                  "avg_cpu": "92%",
                  "window_minutes": 5
                }
              },
              "sig": "sig_controller_alert"
            }
          },

          "ERROR": {
            "direction": "ControllerToAgent OR AgentToController",
            "description": "Generic protocol-level error; not command-specific.",
            "body_schema": {
              "error_code": "string; e.g. 'PROTO_INVALID_MESSAGE' | 'UNSUPPORTED_TYPE'",
              "error_message": "short description",
              "related_message_id": "optional message_id reference",
              "retryable": "boolean; indicates if the sender may retry"
            },
            "example": {
              "message_id": "m-error-001",
              "timestamp": "2025-11-22T12:07:00Z",
              "type": "ERROR",
              "from": "controller",
              "device_id": "PC001",
              "session_id": "sess-789",
              "body": {
                "error_code": "PROTO_INVALID_MESSAGE",
                "error_message": "Missing required field 'body' for TELEMETRY.",
                "related_message_id": "m-tel-bad-123",
                "retryable": false
              },
              "sig": "sig_controller_error"
            }
          }
        },

        "BehavioralContract": {
          "AgentMust": [
            "Send AUTH as the first message in a new WSS connection.",
            "Wait for AUTH_ACK before sending any HEARTBEAT, TELEMETRY, COMMAND_ACK or COMMAND_RESULT.",
            "Sign all messages with its device private key.",
            "Respect heartbeat_interval_seconds provided in AUTH_ACK.",
            "Reject COMMAND_DELIVERY messages whose inner command_envelope signature or TTL is invalid.",
            "Emit COMMAND_ACK promptly after receiving a valid COMMAND_DELIVERY."
          ],
          "ControllerMust": [
            "Close the connection or send AUTH_ERROR if AUTH validation fails.",
            "Only treat the Agent as online if periodic HEARTBEAT messages are received.",
            "Validate signature and schema for every Agent message; discard invalid ones and optionally send ERROR.",
            "Use COMMAND_DELIVERY only for commands already authorized at server-side policy layer.",
            "Send UPDATE_ANNOUNCE and POLICY_UPDATE only for this device_id and tenant context.",
            "Ensure ALERT messages contain no sensitive or identifying user data beyond what is necessary."
          ]
        }
      },

      "FastAPI_Laravel_Interface": {
        "version": "1.0",
        "purpose": "Defines the REST + webhook protocol between FastAPI (device controller) and Laravel (auth, policy, CA, command orchestrator).",
        "transport": "HTTPS (TLS 1.3)",
        "content_type": "application/json",
        "signature": "Laravel signs outbound webhooks using Ed25519; FastAPI signs inbound requests via service key",

        "Endpoints": {
          "Laravel_to_FastAPI": {
            "description": "Laravel pushes commands, policies, and updates into FastAPI.",
            "base_url": "https://fastapi.internal/api/v1",

            "POST_/command/dispatch": {
              "purpose": "Laravel sends a fully authorized command envelope to FastAPI for device routing.",
              "request_schema": {
                "command_id": "UUID",
                "device_id": "string",
                "trace_id": "UUID",
                "seq": "integer",
                "envelope": {
                  "header": {
                    "version": "string",
                    "timestamp": "ISO8601",
                    "ttl_seconds": "integer",
                    "priority": "string",
                    "requires_ack": "boolean",
                    "long_running": "boolean"
                  },
                  "body": {
                    "method": "string",
                    "params": "object",
                    "sensitive": "boolean"
                  },
                  "meta": {
                    "origin_user_id": "string",
                    "enc": "string (none|aes256gcm)",
                    "enc_key_id": "string|null",
                    "policy_version": "string"
                  },
                  "sig": "string (Laravel signature)"
                }
              },
              "response_schema": {
                "status": "'queued'|'dispatched'|'backpressure'|'device_offline'",
                "device_id": "string",
                "command_id": "UUID",
                "reason": "string|null"
              }
            },

            "POST_/policy/push": {
              "purpose": "Laravel broadcasts new policy bundle to FastAPI for redistribution.",
              "request_schema": {
                "policy_version": "string",
                "policy_hash": "sha256",
                "policy_url": "string",
                "signed_at": "ISO8601",
                "signature": "Ed25519 signature"
              },
              "response_schema": {
                "status": "'accepted'|'rejected'",
                "reason": "string|null"
              }
            },

            "POST_/update/deploy": {
              "purpose": "Laravel instructs FastAPI to announce a new OTA update to devices.",
              "request_schema": {
                "release_id": "string",
                "version": "string",
                "manifest_url": "string",
                "signature_url": "string",
                "sha256": "string",
                "min_os_build": "string",
                "rollout_stage": "string ('canary'|'beta'|'general')",
                "policy": {
                  "auto_install": "boolean",
                  "allow_reboot": "boolean"
                }
              },
              "response_schema": {
                "status": "'broadcasted'|'queued'|'failed'",
                "reason": "string|null"
              }
            }
          },

          "FastAPI_to_Laravel": {
            "description": "FastAPI reports device activity, command results, telemetry summaries, and attestation status.",
            "base_url": "https://laravel.internal/api/v1/webhook",

            "POST_/device/online": {
              "purpose": "FastAPI notifies Laravel that a device is online.",
              "request_schema": {
                "device_id": "string",
                "session_id": "UUID",
                "agent_version": "string",
                "os_build": "string",
                "attestation_hash": "string",
                "connected_at": "ISO8601"
              },
              "response_schema": {
                "status": "'ack'"
              }
            },

            "POST_/device/offline": {
              "purpose": "FastAPI notifies Laravel a device disconnected.",
              "request_schema": {
                "device_id": "string",
                "session_id": "UUID",
                "last_seen": "ISO8601",
                "reason": "string ('disconnect'|'error'|'timeout')"
              },
              "response_schema": {
                "status": "'ack'"
              }
            },

            "POST_/command/result": {
              "purpose": "Agent → FastAPI → Laravel final execution result.",
              "request_schema": {
                "command_id": "UUID",
                "device_id": "string",
                "trace_id": "UUID",
                "execution_state": "'completed'|'failed'|'partial'|'executing'",
                "result": {
                  "status": "'ok'|'error'",
                  "notes": "string|null",
                  "artifact_url": "string|null",
                  "artifact_checksum": "string|null"
                },
                "error_code": "integer|null",
                "error_message": "string|null",
                "timestamp": "ISO8601"
              },
              "response_schema": {
                "status": "'received'",
                "audit_id": "UUID"
              }
            },

            "POST_/command/ack": {
              "purpose": "FastAPI forwards Agent command acknowledgment.",
              "request_schema": {
                "command_id": "UUID",
                "device_id": "string",
                "status": "'received'|'rejected'",
                "reason": "string|null",
                "timestamp": "ISO8601"
              },
              "response_schema": {
                "status": "'ok'"
              }
            },

            "POST_/telemetry/summary": {
              "purpose": "FastAPI submits aggregated telemetry (hourly or batch).",
              "request_schema": {
                "device_id": "string",
                "timestamp": "ISO8601",
                "rollup": {
                  "avg_cpu": "number",
                  "avg_ram": "number",
                  "avg_disk": "number",
                  "max_cpu": "number",
                  "risk_score_avg": "number"
                }
              },
              "response_schema": {
                "status": "'ok'"
              }
            },

            "POST_/security/attestation": {
              "purpose": "FastAPI sends attestation results from the Agent.",
              "request_schema": {
                "device_id": "string",
                "timestamp": "ISO8601",
                "attestation": {
                  "agent_hash": "string",
                  "kernelservice_hash": "string",
                  "tpm_quote": "string|null",
                  "status": "'pass'|'mismatch'|'unknown'"
                }
              },
              "response_schema": {
                "status": "'ack'",
                "action_required": "'none'|'quarantine'|'notify'"
              }
            }
          }
        },

        "EventContracts": {
          "FastAPI_to_Laravel": {
            "command_finalized": {
              "trigger": "COMMAND_RESULT from Agent",
              "guarantee": "Laravel will persist to DB and append audit.",
              "failure_mode": "FastAPI queues to DLQ topic and retries."
            },
            "device_presence_change": {
              "trigger": "Agent CONNECT/DISCONNECT",
              "guarantee": "Laravel updates device last_seen and presence flags."
            }
          },
          "Laravel_to_FastAPI": {
            "command_dispatch": {
              "trigger": "User issues command",
              "guarantee": "FastAPI routes to WSS-connected Agent if online."
            },
            "policy_broadcast": {
              "trigger": "Policy version changed in Laravel",
              "guarantee": "FastAPI stores latest hash + distributes over WSS."
            }
          }
        },

        "Security": {
          "InboundRequestsToFastAPI": {
            "auth": "Laravel signs with service private key",
            "header": "X-Laravel-Signature: base64-ed25519",
            "verify": "FastAPI verifies using Laravel’s public key"
          },
          "OutboundRequestsToLaravel": {
            "auth": "FastAPI signs using its service key",
            "header": "X-FastAPI-Signature",
            "verify": "Laravel verifies using FastAPI’s public key"
          },
          "RateLimits": {
            "command_dispatch": "50 requests per second",
            "telemetry_summary": "300 requests per minute"
          }
        },

        "Examples": {
          "Laravel_Dispatch_Command": {
            "request": {
              "command_id": "CMD-123",
              "device_id": "PC001",
              "trace_id": "TRACE-111",
              "seq": 1,
              "envelope": {
                "header": {
                  "version": "1.1",
                  "timestamp": "2025-11-22T12:00:00Z",
                  "ttl_seconds": 300,
                  "priority": "normal",
                  "requires_ack": true,
                  "long_running": false
                },
                "body": {
                  "method": "lock_screen",
                  "params": {},
                  "sensitive": false
                },
                "meta": {
                  "origin_user_id": "UID001",
                  "enc": "none",
                  "enc_key_id": null,
                  "policy_version": "policy-2025-11-01"
                },
                "sig": "sig_laravel"
              }
            },
            "response": {
              "status": "dispatched",
              "device_id": "PC001",
              "command_id": "CMD-123",
              "reason": null
            }
          },

          "FastAPI_Command_Result_To_Laravel": {
            "request": {
              "command_id": "CMD-123",
              "device_id": "PC001",
              "trace_id": "TRACE-111",
              "execution_state": "completed",
              "result": {
                "status": "ok",
                "notes": "",
                "artifact_url": null,
                "artifact_checksum": null
              },
              "error_code": null,
              "error_message": null,
              "timestamp": "2025-11-22T12:00:10Z"
            },
            "response": {
              "status": "received",
              "audit_id": "AUD-999"
            }
          }
        }
      },

      "Laravel_MobileApp_Interface": {
        "version": "1.0",
        "purpose": "Defines REST and push/WSS request/response data between the Mobile App (Flutter) and Laravel backend.",
        "transport": {
          "rest": {
            "protocol": "HTTPS (TLS 1.3)",
            "content_type": "application/json"
          },
          "realtime": {
            "protocol": "WSS",
            "usage": "notifications, live telemetry, command updates"
          }
        },

        "AuthAndIdentity": {
          "POST_/api/register": {
            "purpose": "Create a new user and initial session.",
            "request_schema": {
              "email": "string (valid email)",
              "password": "string (min length 8 or per policy)",
              "display_name": "string",
              "pubkey": "string (Mobile app public key for end-to-end signatures)"
            },
            "response_schema": {
              "user_id": "string (UID)",
              "jwt": "string (access token)",
              "refresh_token": "string",
              "requires_2fa_enrollment": "boolean"
            }
          },
          "POST_/api/login": {
            "purpose": "Authenticate existing user and return session tokens.",
            "request_schema": {
              "email": "string",
              "password": "string",
              "device_fingerprint": "string (mobile device identifier)",
              "two_factor_code": "string|null (if already enrolled)",
              "push_token": "string|null (FCM/APNS token for push)"
            },
            "response_schema": {
              "user_id": "string",
              "jwt": "string",
              "refresh_token": "string",
              "session_id": "string",
              "two_factor_required": "boolean",
              "two_factor_pending": "boolean"
            }
          },
          "POST_/api/2fa/verify": {
            "purpose": "Complete 2FA challenge for login or sensitive action.",
            "request_schema": {
              "user_id": "string",
              "session_id": "string",
              "two_factor_code": "string"
            },
            "response_schema": {
              "status": "'ok'|'invalid'|'expired'",
              "jwt": "string|null",
              "refresh_token": "string|null"
            }
          },
          "POST_/api/token/refresh": {
            "purpose": "Refresh JWT using refresh_token.",
            "request_schema": {
              "refresh_token": "string"
            },
            "response_schema": {
              "jwt": "string",
              "refresh_token": "string",
              "expires_in": "integer (seconds)"
            }
          },
          "POST_/api/logout": {
            "purpose": "Invalidate session on this device.",
            "request_schema": {
              "session_id": "string",
              "all_devices": "boolean"
            },
            "response_schema": {
              "status": "'ok'"
            }
          }
        },

        "DeviceManagement": {
          "GET_/api/devices": {
            "purpose": "List devices owned/accessible by the user.",
            "request_query": {
              "status": "optional string filter (active|quarantine|decommissioned)",
              "search": "optional string filter"
            },
            "response_schema": {
              "devices": [
                {
                  "device_id": "string",
                  "device_name": "string",
                  "lifecycle_state": "string (active|quarantine|decommissioned|pending_pairing)",
                  "last_seen": "ISO8601|null",
                  "agent_version": "string|null",
                  "os_build": "string|null",
                  "compliance_status": "string (compliant|non_compliant|unknown)",
                  "risk_score": "number|null"
                }
              ]
            }
          },
          "GET_/api/devices/{device_id}": {
            "purpose": "Get detailed info for a single device.",
            "response_schema": {
              "device_id": "string",
              "device_name": "string",
              "hwid": "string (may be redacted/hashed for privacy)",
              "lifecycle_state": "string",
              "last_seen": "ISO8601|null",
              "agent_version": "string|null",
              "os_build": "string|null",
              "policy_hash": "string|null",
              "compliance": {
                "status": "string",
                "last_evaluated_at": "ISO8601|null",
                "reasons": "array of string"
              },
              "telemetry_latest": {
                "cpu": "string|null",
                "ram": "string|null",
                "disk_usage": "string|null",
                "risk_score": "number|null",
                "timestamp": "ISO8601|null"
              }
            }
          },
          "POST_/api/devices/{device_id}/rename": {
            "purpose": "Rename a device for UI convenience.",
            "request_schema": {
              "new_name": "string"
            },
            "response_schema": {
              "status": "'ok'",
              "device_id": "string",
              "device_name": "string"
            }
          }
        },

        "PairingAndQR": {
          "POST_/api/pair/init": {
            "purpose": "Prepare a pairing session; mobile will later scan agent's QR.",
            "request_schema": {
              "device_label": "string (optional user label for new device)"
            },
            "response_schema": {
              "pair_session_id": "string",
              "expires_at": "ISO8601",
              "qr_metadata": {
                "info": "string (for debugging or UI hint; optional)"
              }
            }
          },
          "POST_/api/pair/confirm": {
            "purpose": "Complete pairing using pair_token embedded in the agent's QR.",
            "request_schema": {
              "pair_token": "string (JWT from agent QR)",
              "pair_session_id": "string|null"
            },
            "response_schema": {
              "status": "'ok'|'invalid'|'expired'|'conflict'",
              "device_id": "string|null",
              "device_name": "string|null",
              "lifecycle_state": "string|null"
            }
          }
        },

        "CommandAPI": {
          "POST_/api/commands": {
            "purpose": "User sends a command from mobile to a device.",
            "request_schema": {
              "device_id": "string",
              "method": "string",
              "params": "object",
              "sensitive": "boolean",
              "client_message_id": "string",
              "two_factor_code": "string|null"
            },
            "response_schema": {
              "status": "'accepted'|'rejected'",
              "reason": "string|null",
              "command_id": "string|null",
              "state": "string|null",
              "queued_at": "ISO8601|null"
            }
          },
          "GET_/api/commands/{command_id}": {
            "purpose": "Fetch current state and result of a specific command.",
            "response_schema": {
              "command_id": "string",
              "device_id": "string",
              "method": "string",
              "params": "object",
              "state": "string",
              "queued_at": "ISO8601",
              "completed_at": "ISO8601|null",
              "result": {
                "status": "'ok'|'error'|null",
                "notes": "string|null",
                "artifact_url": "string|null",
                "artifact_checksum": "string|null"
              },
              "error_code": "integer|null",
              "error_message": "string|null"
            }
          },
          "GET_/api/devices/{device_id}/commands": {
            "purpose": "List recent commands for a device.",
            "request_query": {
              "limit": "integer (default 20)",
              "before": "ISO8601|null"
            },
            "response_schema": {
              "commands": [
                {
                  "command_id": "string",
                  "method": "string",
                  "state": "string",
                  "queued_at": "ISO8601",
                  "completed_at": "ISO8601|null"
                }
              ],
              "next_before": "ISO8601|null"
            }
          }
        },

        "TelemetryAndStatus": {
          "GET_/api/devices/{device_id}/telemetry/latest": {
            "purpose": "Fetch last telemetry snapshot for a device.",
            "response_schema": {
              "device_id": "string",
              "timestamp": "ISO8601|null",
              "metrics": {
                "cpu": "string|null",
                "ram": "string|null",
                "disk_usage": "string|null",
                "network_tx": "string|null",
                "network_rx": "string|null",
                "risk_score": "number|null"
              }
            }
          },
          "GET_/api/devices/{device_id}/telemetry/history": {
            "purpose": "Fetch summarized telemetry history.",
            "request_query": {
              "from": "ISO8601",
              "to": "ISO8601",
              "bucket": "string ('hour'|'day')"
            },
            "response_schema": {
              "device_id": "string",
              "bucket": "string",
              "points": [
                {
                  "timestamp": "ISO8601",
                  "avg_cpu": "number",
                  "avg_ram": "number",
                  "avg_disk_usage": "number",
                  "risk_score_avg": "number"
                }
              ]
            }
          }
        },

        "UpdatesAndOTA": {
          "GET_/api/devices/{device_id}/updates": {
            "purpose": "Show update history for a device.",
            "response_schema": {
              "device_id": "string",
              "updates": [
                {
                  "release_id": "string",
                  "version": "string",
                  "status": "string",
                  "last_update_at": "ISO8601",
                  "rollback_available": "boolean"
                }
              ]
            }
          },
          "GET_/api/devices/{device_id}/updates/{release_id}": {
            "purpose": "Detailed status of a specific update.",
            "response_schema": {
              "device_id": "string",
              "release_id": "string",
              "version": "string",
              "phase": "string",
              "progress": {
                "percent": "integer",
                "detail": "string|null"
              },
              "error_code": "integer|null",
              "error_message": "string|null",
              "rollback_snapshot_id": "string|null"
            }
          }
        },

        "AuditAndAlerts": {
          "GET_/api/audit/device/{device_id}": {
            "purpose": "Get audit entries related to the user’s device.",
            "request_query": {
              "limit": "integer (default 50)",
              "before": "ISO8601|null"
            },
            "response_schema": {
              "entries": [
                {
                  "id": "string",
                  "timestamp": "ISO8601",
                  "event_type": "string",
                  "summary": "string",
                  "details": "object|null"
                }
              ],
              "next_before": "ISO8601|null"
            }
          },
          "GET_/api/alerts": {
            "purpose": "List active/recent alerts for the user’s devices.",
            "request_query": {
              "severity": "string|null ('info|warning|critical')",
              "limit": "integer (default 20)"
            },
            "response_schema": {
              "alerts": [
                {
                  "alert_id": "string",
                  "device_id": "string",
                  "severity": "string",
                  "category": "string",
                  "message": "string",
                  "timestamp": "ISO8601",
                  "acknowledged": "boolean"
                }
              ]
            }
          },
          "POST_/api/alerts/{alert_id}/ack": {
            "purpose": "User acknowledges an alert.",
            "request_schema": {},
            "response_schema": {
              "status": "'ok'",
              "alert_id": "string",
              "acknowledged_at": "ISO8601"
            }
          }
        },

        "RealtimeChannel": {
          "ws_url_example": "wss://api.example.com/mobile/notifications",
          "CommonEnvelope": {
            "schema": {
              "message_id": "UUID",
              "timestamp": "ISO8601",
              "type": "string ('command_update'|'alert'|'update_status'|'telemetry_live')",
              "device_id": "string|null",
              "body": "object"
            }
          },
          "Types": {
            "command_update": {
              "body_schema": {
                "command_id": "string",
                "state": "string",
                "result_status": "string|null",
                "error_code": "integer|null"
              }
            },
            "alert": {
              "body_schema": {
                "alert_id": "string",
                "device_id": "string",
                "severity": "string",
                "category": "string",
                "message": "string"
              }
            },
            "update_status": {
              "body_schema": {
                "release_id": "string",
                "device_id": "string",
                "phase": "string",
                "percent": "integer"
              }
            },
            "telemetry_live": {
              "body_schema": {
                "device_id": "string",
                "metrics": {
                  "cpu": "string",
                  "ram": "string",
                  "disk_usage": "string"
                },
                "timestamp": "ISO8601"
              }
            }
          }
        },

        "Examples": {
          "SendLockScreenCommand": {
            "request": {
              "device_id": "PC001",
              "method": "lock_screen",
              "params": {},
              "sensitive": false,
              "client_message_id": "mobile-123",
              "two_factor_code": null
            },
            "response": {
              "status": "accepted",
              "reason": null,
              "command_id": "CMD-0001-uuid",
              "state": "queued",
              "queued_at": "2025-11-22T12:00:00Z"
            }
          },
          "CommandResultNotification_WebSocket": {
            "message": {
              "message_id": "ws-evt-001",
              "timestamp": "2025-11-22T12:00:11Z",
              "type": "command_update",
              "device_id": "PC001",
              "body": {
                "command_id": "CMD-0001-uuid",
                "state": "completed",
                "result_status": "ok",
                "error_code": null
              }
            }
          }
        }
      },

      "InternalComponents": {
        "version": "1.0",
        "purpose": "Defines all missing internal service contracts required for a complete end-to-end system.",

        "PolicyEngine_API": {
          "description": "Central rules evaluator used by Laravel and FastAPI.",
          "POST_/policy/evaluate": {
            "purpose": "Evaluate any user → device → command request.",
            "request_schema": {
              "user_id": "string",
              "device_id": "string",
              "method": "string",
              "params": "object",
              "device_lifecycle_state": "string",
              "user_role": "string",
              "policy_hash": "string",
              "command_risk_level": "string ('low'|'medium'|'high')",
              "timestamp": "ISO8601"
            },
            "response_schema": {
              "decision": "'allow'|'deny'|'require_2fa'",
              "reason": "string"
            }
          },
          "POST_/policy/validate_bundle": {
            "purpose": "Validate a policy bundle before publishing.",
            "request_schema": {
              "policy_version": "string",
              "rules": "object",
              "signature": "string"
            },
            "response_schema": {
              "status": "'valid'|'invalid'",
              "errors": "array of string"
            }
          }
        },

        "CommandRegistry_API": {
          "GET_/commands": {
            "purpose": "List all valid commands recognized by backend + agent.",
            "response_schema": {
              "commands": [
                {
                  "command_name": "string",
                  "risk_level": "string",
                  "min_role": "string",
                  "requires_2fa": "boolean",
                  "allowed_in_quarantine": "boolean",
                  "params_schema": "object"
                }
              ]
            }
          },
          "POST_/commands/validate": {
            "description": "Validate method + params during ingestion.",
            "request_schema": {
              "method": "string",
              "params": "object"
            },
            "response_schema": {
              "status": "'ok'|'invalid_method'|'invalid_params'",
              "errors": "array of string|null"
            }
          }
        },

        "TelemetryAnalytics_API": {
          "POST_/analytics/risk/score": {
            "purpose": "Compute risk score for a telemetry sample.",
            "request_schema": {
              "device_id": "string",
              "telemetry": {
                "cpu": "string",
                "ram": "string",
                "disk_usage": "string",
                "network_tx": "string",
                "network_rx": "string"
              },
              "timestamp": "ISO8601"
            },
            "response_schema": {
              "risk_score": "number",
              "anomaly_detected": "boolean",
              "anomaly_reason": "string|null"
            }
          },
          "POST_/analytics/rollup/hourly": {
            "purpose": "Store hourly rollups.",
            "request_schema": {
              "device_id": "string",
              "points": [
                {
                  "timestamp": "ISO8601",
                  "avg_cpu": "number",
                  "avg_ram": "number",
                  "avg_disk": "number",
                  "risk_score_avg": "number"
                }
              ]
            },
            "response_schema": {
              "status": "'ok'"
            }
          }
        },

        "ComplianceEngine_API": {
          "POST_/compliance/evaluate": {
            "purpose": "Compute compliance status given device metadata + telemetry.",
            "request_schema": {
              "device_id": "string",
              "profile_id": "string",
              "agent_version": "string",
              "os_build": "string",
              "policy_hash": "string",
              "attestation_status": "string",
              "last_update_state": "string"
            },
            "response_schema": {
              "status": "'compliant'|'non_compliant'|'unknown'",
              "reasons": "array of string"
            }
          },
          "GET_/compliance/profiles": {
            "purpose": "Return all compliance rule sets.",
            "response_schema": {
              "profiles": [
                {
                  "profile_id": "string",
                  "rules": "object",
                  "description": "string"
                }
              ]
            }
          }
        },

        "AttestationEvaluator_API": {
          "POST_/attestation/verify": {
            "purpose": "Verify attestation hashes and TPM quotes.",
            "request_schema": {
              "device_id": "string",
              "agent_hash": "string",
              "kernelservice_hash": "string",
              "tpm_quote": "string|null",
              "valid_agent_hashes": "array of string",
              "valid_kernel_hashes": "array of string"
            },
            "response_schema": {
              "status": "'pass'|'fail'|'mismatch'",
              "action": "'none'|'quarantine'|'notify'",
              "reason": "string"
            }
          }
        },

        "OTAService_API": {
          "GET_/ota/manifest/{release_id}": {
            "purpose": "Retrieve update manifest.",
            "response_schema": {
              "release_id": "string",
              "version": "string",
              "files": [
                {
                  "path": "string",
                  "sha256": "string",
                  "size_bytes": "integer"
                }
              ],
              "signature": "string",
              "sbom_url": "string"
            }
          },
          "GET_/ota/chunk": {
            "purpose": "Serve OTA file chunk.",
            "request_query": {
              "path": "string",
              "offset": "integer",
              "length": "integer"
            },
            "response_schema": {
              "data": "base64-encoded chunk",
              "sha256": "string"
            }
          },
          "POST_/ota/report": {
            "purpose": "Device reports chunk progress (via pipeline).",
            "request_schema": {
              "device_id": "string",
              "release_id": "string",
              "phase": "string",
              "percent": "integer"
            },
            "response_schema": {
              "status": "'ok'"
            }
          }
        },

        "AuditTrail_API": {
          "POST_/audit/append": {
            "purpose": "Any service records an audit event.",
            "request_schema": {
              "audit_id": "string",
              "actor": "string (user|system|device)",
              "actor_id": "string",
              "event_type": "string",
              "device_id": "string|null",
              "timestamp": "ISO8601",
              "payload_hash": "sha256",
              "prev_hash": "sha256|null",
              "signature": "string"
            },
            "response_schema": {
              "status": "'ok'",
              "stored_hash": "sha256"
            }
          },
          "GET_/audit/chain/{device_id}": {
            "purpose": "Retrieve hash-linked chain for verification.",
            "response_schema": {
              "entries": [
                {
                  "audit_id": "string",
                  "hash": "sha256",
                  "prev_hash": "sha256|null",
                  "sig": "string",
                  "timestamp": "ISO8601"
                }
              ]
            }
          }
        },

        "EventBus_Interface": {
          "description": "Internal Redis/Kafka-like event publisher contract.",
          "events": {
            "command.dispatched": {
              "schema": {
                "command_id": "string",
                "device_id": "string",
                "timestamp": "ISO8601"
              }
            },
            "device.online": {
              "schema": {
                "device_id": "string",
                "session_id": "string",
                "timestamp": "ISO8601"
              }
            },
            "device.offline": {
              "schema": {
                "device_id": "string",
                "timestamp": "ISO8601",
                "reason": "string"
              }
            },
            "telemetry.ingest": {
              "schema": {
                "device_id": "string",
                "metrics": "object",
                "timestamp": "ISO8601"
              }
            },
            "policy.update": {
              "schema": {
                "policy_version": "string",
                "timestamp": "ISO8601"
              }
            },
            "update.progress": {
              "schema": {
                "device_id": "string",
                "release_id": "string",
                "phase": "string",
                "percent": "integer",
                "timestamp": "ISO8601"
              }
            }
          }
        },

        "AdminConsole_API": {
          "GET_/admin/users": {
            "response_schema": {
              "users": [
                {
                  "user_id": "string",
                  "email": "string",
                  "role": "string",
                  "status": "string",
                  "created_at": "ISO8601"
                }
              ]
            }
          },
          "GET_/admin/devices": {
            "response_schema": {
              "devices": [
                {
                  "device_id": "string",
                  "user_id": "string",
                  "lifecycle_state": "string",
                  "agent_version": "string",
                  "os_build": "string"
                }
              ]
            }
          },
          "POST_/admin/devices/{device_id}/quarantine": {
            "purpose": "Force device into quarantine.",
            "response_schema": {
              "status": "'ok'",
              "device_id": "string",
              "new_state": "'quarantine'"
            }
          }
        },

        "FailoverController_API": {
          "GET_/health/check": {
            "purpose": "Health check endpoint.",
            "response_schema": {
              "status": "'ok'|'degraded'",
              "components": {
                "mysql": "string",
                "redis": "string",
                "fastapi_ws_cluster": "string",
                "object_store": "string"
              }
            }
          },
          "GET_/failover/state": {
            "response_schema": {
              "primary_region": "string",
              "secondary_region": "string",
              "replication_lag_seconds": "integer"
            }
          },
          "POST_/failover/trigger": {
            "purpose": "Manually trigger failover (lab/demo only).",
            "response_schema": {
              "status": "'initiated'",
              "new_primary": "string"
            }
          }
        }
      }
    }
  }
}
