{
  "InternalComponents": {
    "version": "1.0",
    "purpose": "Defines all missing internal service contracts required for a complete end-to-end system.",

    "PolicyEngine_API": {
      "description": "Central rules evaluator used by Laravel and FastAPI.",
      "POST_/policy/evaluate": {
        "purpose": "Evaluate any user → device → command request.",
        "request_schema": {
          "user_id": "string",
          "device_id": "string",
          "method": "string",
          "params": "object",
          "device_lifecycle_state": "string",
          "user_role": "string",
          "policy_hash": "string",
          "command_risk_level": "string ('low'|'medium'|'high')",
          "timestamp": "ISO8601"
        },
        "response_schema": {
          "decision": "'allow'|'deny'|'require_2fa'",
          "reason": "string"
        }
      },

      "POST_/policy/validate_bundle": {
        "purpose": "Validate a policy bundle before publishing.",
        "request_schema": {
          "policy_version": "string",
          "rules": "object",
          "signature": "string"
        },
        "response_schema": {
          "status": "'valid'|'invalid'",
          "errors": "array of string"
        }
      }
    },

    "CommandRegistry_API": {
      "GET_/commands": {
        "purpose": "List all valid commands recognized by backend + agent.",
        "response_schema": {
          "commands": [
            {
              "command_name": "string",
              "risk_level": "string",
              "min_role": "string",
              "requires_2fa": "boolean",
              "allowed_in_quarantine": "boolean",
              "params_schema": "object"
            }
          ]
        }
      },
      "POST_/commands/validate": {
        "description": "Validate method + params during ingestion.",
        "request_schema": {
          "method": "string",
          "params": "object"
        },
        "response_schema": {
          "status": "'ok'|'invalid_method'|'invalid_params'",
          "errors": "array of string|null"
        }
      }
    },

    "TelemetryAnalytics_API": {
      "POST_/analytics/risk/score": {
        "purpose": "Compute risk score for a telemetry sample.",
        "request_schema": {
          "device_id": "string",
          "telemetry": {
            "cpu": "string",
            "ram": "string",
            "disk_usage": "string",
            "network_tx": "string",
            "network_rx": "string"
          },
          "timestamp": "ISO8601"
        },
        "response_schema": {
          "risk_score": "number",
          "anomaly_detected": "boolean",
          "anomaly_reason": "string|null"
        }
      },

      "POST_/analytics/rollup/hourly": {
        "purpose": "Store hourly rollups.",
        "request_schema": {
          "device_id": "string",
          "points": [
            {
              "timestamp": "ISO8601",
              "avg_cpu": "number",
              "avg_ram": "number",
              "avg_disk": "number",
              "risk_score_avg": "number"
            }
          ]
        },
        "response_schema": {
          "status": "'ok'"
        }
      }
    },

    "ComplianceEngine_API": {
      "POST_/compliance/evaluate": {
        "purpose": "Compute compliance status given device metadata + telemetry.",
        "request_schema": {
          "device_id": "string",
          "profile_id": "string",
          "agent_version": "string",
          "os_build": "string",
          "policy_hash": "string",
          "attestation_status": "string",
          "last_update_state": "string"
        },
        "response_schema": {
          "status": "'compliant'|'non_compliant'|'unknown'",
          "reasons": "array of string"
        }
      },

      "GET_/compliance/profiles": {
        "purpose": "Return all compliance rule sets.",
        "response_schema": {
          "profiles": [
            {
              "profile_id": "string",
              "rules": "object",
              "description": "string"
            }
          ]
        }
      }
    },

    "AttestationEvaluator_API": {
      "POST_/attestation/verify": {
        "purpose": "Verify attestation hashes and TPM quotes.",
        "request_schema": {
          "device_id": "string",
          "agent_hash": "string",
          "kernelservice_hash": "string",
          "tpm_quote": "string|null",
          "valid_agent_hashes": "array of string",
          "valid_kernel_hashes": "array of string"
        },
        "response_schema": {
          "status": "'pass'|'fail'|'mismatch'",
          "action": "'none'|'quarantine'|'notify'",
          "reason": "string"
        }
      }
    },

    "OTAService_API": {
      "GET_/ota/manifest/{release_id}": {
        "purpose": "Retrieve update manifest.",
        "response_schema": {
          "release_id": "string",
          "version": "string",
          "files": [
            {
              "path": "string",
              "sha256": "string",
              "size_bytes": "integer"
            }
          ],
          "signature": "string (detached signature)",
          "sbom_url": "string"
        }
      },

      "GET_/ota/chunk": {
        "purpose": "Serve OTA file chunk.",
        "request_query": {
          "path": "string",
          "offset": "integer",
          "length": "integer"
        },
        "response_schema": {
          "data": "base64-encoded chunk",
          "sha256": "string"
        }
      },

      "POST_/ota/report": {
        "purpose": "Device reports chunk progress through FastAPI → Laravel → OTAService.",
        "request_schema": {
          "device_id": "string",
          "release_id": "string",
          "phase": "string",
          "percent": "integer"
        },
        "response_schema": {
          "status": "'ok'"
        }
      }
    },

    "AuditTrail_API": {
      "POST_/audit/append": {
        "purpose": "Any service records an audit event.",
        "request_schema": {
          "audit_id": "string",
          "actor": "string (user|system|device)",
          "actor_id": "string",
          "event_type": "string",
          "device_id": "string|null",
          "timestamp": "ISO8601",
          "payload_hash": "sha256",
          "prev_hash": "sha256|null",
          "signature": "string"
        },
        "response_schema": {
          "status": "'ok'",
          "stored_hash": "sha256"
        }
      },

      "GET_/audit/chain/{device_id}": {
        "purpose": "Retrieve hash-linked chain for verification.",
        "response_schema": {
          "entries": [
            {
              "audit_id": "string",
              "hash": "sha256",
              "prev_hash": "sha256|null",
              "sig": "string",
              "timestamp": "ISO8601"
            }
          ]
        }
      }
    },

    "EventBus_Interface": {
      "description": "Internal Redis/Kafka-like event publisher contract.",
      "events": {
        "command.dispatched": {
          "schema": {
            "command_id": "string",
            "device_id": "string",
            "timestamp": "ISO8601"
          }
        },
        "device.online": {
          "schema": {
            "device_id": "string",
            "session_id": "string",
            "timestamp": "ISO8601"
          }
        },
        "device.offline": {
          "schema": {
            "device_id": "string",
            "timestamp": "ISO8601",
            "reason": "string"
          }
        },
        "telemetry.ingest": {
          "schema": {
            "device_id": "string",
            "metrics": "object",
            "timestamp": "ISO8601"
          }
        },
        "policy.update": {
          "schema": {
            "policy_version": "string",
            "timestamp": "ISO8601"
          }
        },
        "update.progress": {
          "schema": {
            "device_id": "string",
            "release_id": "string",
            "phase": "string",
            "percent": "integer",
            "timestamp": "ISO8601"
          }
        }
      }
    },

    "AdminConsole_API": {
      "GET_/admin/users": {
        "response_schema": {
          "users": [
            {
              "user_id": "string",
              "email": "string",
              "role": "string",
              "status": "string",
              "created_at": "ISO8601"
            }
          ]
        }
      },

      "GET_/admin/devices": {
        "response_schema": {
          "devices": [
            {
              "device_id": "string",
              "user_id": "string",
              "lifecycle_state": "string",
              "agent_version": "string",
              "os_build": "string"
            }
          ]
        }
      },

      "POST_/admin/devices/{device_id}/quarantine": {
        "purpose": "Force device into quarantine.",
        "response_schema": {
          "status": "'ok'",
          "device_id": "string",
          "new_state": "'quarantine'"
        }
      }
    },

    "FailoverController_API": {
      "GET_/health/check": {
        "purpose": "Health check endpoint.",
        "response_schema": {
          "status": "'ok'|'degraded'",
          "components": {
            "mysql": "string",
            "redis": "string",
            "fastapi_ws_cluster": "string",
            "object_store": "string"
          }
        }
      },

      "GET_/failover/state": {
        "response_schema": {
          "primary_region": "string",
          "secondary_region": "string",
          "replication_lag_seconds": "integer"
        }
      },

      "POST_/failover/trigger": {
        "purpose": "Manually trigger failover (lab/demo only).",
        "response_schema": {
          "status": "'initiated'",
          "new_primary": "string"
        }
      }
    }
  }
}
