{
  "Laravel_MobileApp_Interface": {
    "version": "1.0",
    "purpose": "Defines REST and push/WSS request/response data between the Mobile App (Flutter) and Laravel backend.",
    "transport": {
      "rest": {
        "protocol": "HTTPS (TLS 1.3)",
        "content_type": "application/json"
      },
      "realtime": {
        "protocol": "WSS",
        "usage": "notifications, live telemetry, command updates"
      }
    },

    "AuthAndIdentity": {
      "POST_/api/register": {
        "purpose": "Create a new user and initial session.",
        "request_schema": {
          "email": "string (valid email)",
          "password": "string (min length 8 or per policy)",
          "display_name": "string",
          "pubkey": "string (Mobile app public key for end-to-end signatures)"
        },
        "response_schema": {
          "user_id": "string (UID)",
          "jwt": "string (access token)",
          "refresh_token": "string",
          "requires_2fa_enrollment": "boolean"
        }
      },

      "POST_/api/login": {
        "purpose": "Authenticate existing user and return session tokens.",
        "request_schema": {
          "email": "string",
          "password": "string",
          "device_fingerprint": "string (mobile device identifier)",
          "two_factor_code": "string|null (if already enrolled)",
          "push_token": "string|null (FCM/APNS token for push)"
        },
        "response_schema": {
          "user_id": "string",
          "jwt": "string",
          "refresh_token": "string",
          "session_id": "string",
          "two_factor_required": "boolean",
          "two_factor_pending": "boolean"
        }
      },

      "POST_/api/2fa/verify": {
        "purpose": "Complete 2FA challenge for login or sensitive action.",
        "request_schema": {
          "user_id": "string",
          "session_id": "string",
          "two_factor_code": "string"
        },
        "response_schema": {
          "status": "'ok'|'invalid'|'expired'",
          "jwt": "string|null (new access token if successful)",
          "refresh_token": "string|null"
        }
      },

      "POST_/api/token/refresh": {
        "purpose": "Refresh JWT using refresh_token.",
        "request_schema": {
          "refresh_token": "string"
        },
        "response_schema": {
          "jwt": "string",
          "refresh_token": "string",
          "expires_in": "integer (seconds)"
        }
      },

      "POST_/api/logout": {
        "purpose": "Invalidate session on this device.",
        "request_schema": {
          "session_id": "string",
          "all_devices": "boolean"
        },
        "response_schema": {
          "status": "'ok'"
        }
      }
    },

    "DeviceManagement": {
      "GET_/api/devices": {
        "purpose": "List devices owned/accessible by the user.",
        "request_query": {
          "status": "optional string filter (active|quarantine|decommissioned)",
          "search": "optional string filter"
        },
        "response_schema": {
          "devices": [
            {
              "device_id": "string",
              "device_name": "string",
              "lifecycle_state": "string (active|quarantine|decommissioned|pending_pairing)",
              "last_seen": "ISO8601|null",
              "agent_version": "string|null",
              "os_build": "string|null",
              "compliance_status": "string (compliant|non_compliant|unknown)",
              "risk_score": "number|null"
            }
          ]
        }
      },

      "GET_/api/devices/{device_id}": {
        "purpose": "Get detailed info for a single device.",
        "response_schema": {
          "device_id": "string",
          "device_name": "string",
          "hwid": "string (may be redacted/hashed for privacy)",
          "lifecycle_state": "string",
          "last_seen": "ISO8601|null",
          "agent_version": "string|null",
          "os_build": "string|null",
          "policy_hash": "string|null",
          "compliance": {
            "status": "string",
            "last_evaluated_at": "ISO8601|null",
            "reasons": "array of string"
          },
          "telemetry_latest": {
            "cpu": "string|null",
            "ram": "string|null",
            "disk_usage": "string|null",
            "risk_score": "number|null",
            "timestamp": "ISO8601|null"
          }
        }
      },

      "POST_/api/devices/{device_id}/rename": {
        "purpose": "Rename a device for UI convenience.",
        "request_schema": {
          "new_name": "string"
        },
        "response_schema": {
          "status": "'ok'",
          "device_id": "string",
          "device_name": "string"
        }
      }
    },

    "PairingAndQR": {
      "POST_/api/pair/init": {
        "purpose": "Prepare a pairing session; mobile will later scan agent's QR.",
        "request_schema": {
          "device_label": "string (optional user label for new device)"
        },
        "response_schema": {
          "pair_session_id": "string",
          "expires_at": "ISO8601",
          "qr_metadata": {
            "info": "string (for debugging or UI hint; optional)"
          }
        }
      },

      "POST_/api/pair/confirm": {
        "purpose": "Complete pairing using pair_token embedded in the agent's QR.",
        "request_schema": {
          "pair_token": "string (JWT from agent QR)",
          "pair_session_id": "string|null"
        },
        "response_schema": {
          "status": "'ok'|'invalid'|'expired'|'conflict'",
          "device_id": "string|null",
          "device_name": "string|null",
          "lifecycle_state": "string|null"
        }
      }
    },

    "CommandAPI": {
      "POST_/api/commands": {
        "purpose": "User sends a command from mobile to a device.",
        "request_schema": {
          "device_id": "string",
          "method": "string (must match known command registry name, e.g. 'lock_screen')",
          "params": "object",
          "sensitive": "boolean",
          "client_message_id": "string (client-side id for correlation)",
          "two_factor_code": "string|null (if required by policy)"
        },
        "response_schema": {
          "status": "'accepted'|'rejected'",
          "reason": "string|null",
          "command_id": "string|null",
          "state": "string|null (queued|dispatched|backpressure)",
          "queued_at": "ISO8601|null"
        }
      },

      "GET_/api/commands/{command_id}": {
        "purpose": "Fetch current state and (if available) result of a specific command.",
        "response_schema": {
          "command_id": "string",
          "device_id": "string",
          "method": "string",
          "params": "object",
          "state": "string (queued|sent|ack_received|executing|completed|failed|expired)",
          "queued_at": "ISO8601",
          "completed_at": "ISO8601|null",
          "result": {
            "status": "'ok'|'error'|null",
            "notes": "string|null",
            "artifact_url": "string|null",
            "artifact_checksum": "string|null"
          },
          "error_code": "integer|null",
          "error_message": "string|null"
        }
      },

      "GET_/api/devices/{device_id}/commands": {
        "purpose": "List recent commands for a device (timeline).",
        "request_query": {
          "limit": "integer (default 20)",
          "before": "ISO8601|null (pagination cursor)"
        },
        "response_schema": {
          "commands": [
            {
              "command_id": "string",
              "method": "string",
              "state": "string",
              "queued_at": "ISO8601",
              "completed_at": "ISO8601|null"
            }
          ],
          "next_before": "ISO8601|null"
        }
      }
    },

    "TelemetryAndStatus": {
      "GET_/api/devices/{device_id}/telemetry/latest": {
        "purpose": "Fetch last telemetry snapshot for a device.",
        "response_schema": {
          "device_id": "string",
          "timestamp": "ISO8601|null",
          "metrics": {
            "cpu": "string|null",
            "ram": "string|null",
            "disk_usage": "string|null",
            "network_tx": "string|null",
            "network_rx": "string|null",
            "risk_score": "number|null"
          }
        }
      },

      "GET_/api/devices/{device_id}/telemetry/history": {
        "purpose": "Fetch summarized telemetry history (e.g. charts).",
        "request_query": {
          "from": "ISO8601",
          "to": "ISO8601",
          "bucket": "string ('hour'|'day')"
        },
        "response_schema": {
          "device_id": "string",
          "bucket": "string",
          "points": [
            {
              "timestamp": "ISO8601",
              "avg_cpu": "number",
              "avg_ram": "number",
              "avg_disk_usage": "number",
              "risk_score_avg": "number"
            }
          ]
        }
      }
    },

    "UpdatesAndOTA": {
      "GET_/api/devices/{device_id}/updates": {
        "purpose": "Show update history for a device.",
        "response_schema": {
          "device_id": "string",
          "updates": [
            {
              "release_id": "string",
              "version": "string",
              "status": "string ('pending|downloading|verifying|staged|committing|rebooting|success|failed|rolled_back')",
              "last_update_at": "ISO8601",
              "rollback_available": "boolean"
            }
          ]
        }
      },

      "GET_/api/devices/{device_id}/updates/{release_id}": {
        "purpose": "Detailed status of a specific update.",
        "response_schema": {
          "device_id": "string",
          "release_id": "string",
          "version": "string",
          "phase": "string",
          "progress": {
            "percent": "integer",
            "detail": "string|null"
          },
          "error_code": "integer|null",
          "error_message": "string|null",
          "rollback_snapshot_id": "string|null"
        }
      }
    },

    "AuditAndAlerts": {
      "GET_/api/audit/device/{device_id}": {
        "purpose": "Get audit entries related to the user’s device (user-friendly subset).",
        "request_query": {
          "limit": "integer (default 50)",
          "before": "ISO8601|null"
        },
        "response_schema": {
          "entries": [
            {
              "id": "string",
              "timestamp": "ISO8601",
              "event_type": "string ('command|update|policy|security|system')",
              "summary": "string",
              "details": "object|null"
            }
          ],
          "next_before": "ISO8601|null"
        }
      },

      "GET_/api/alerts": {
        "purpose": "List active/ recent alerts for the user’s devices.",
        "request_query": {
          "severity": "string|null ('info|warning|critical')",
          "limit": "integer (default 20)"
        },
        "response_schema": {
          "alerts": [
            {
              "alert_id": "string",
              "device_id": "string",
              "severity": "string",
              "category": "string",
              "message": "string",
              "timestamp": "ISO8601",
              "acknowledged": "boolean"
            }
          ]
        }
      },

      "POST_/api/alerts/{alert_id}/ack": {
        "purpose": "User acknowledges an alert from the mobile app.",
        "request_schema": {},
        "response_schema": {
          "status": "'ok'",
          "alert_id": "string",
          "acknowledged_at": "ISO8601"
        }
      }
    },

    "RealtimeChannel": {
      "ws_url_example": "wss://api.example.com/mobile/notifications",
      "CommonEnvelope": {
        "schema": {
          "message_id": "UUID",
          "timestamp": "ISO8601",
          "type": "string ('command_update'|'alert'|'update_status'|'telemetry_live')",
          "device_id": "string|null",
          "body": "object (type-specific)"
        }
      },
      "Types": {
        "command_update": {
          "body_schema": {
            "command_id": "string",
            "state": "string",
            "result_status": "string|null",
            "error_code": "integer|null"
          }
        },
        "alert": {
          "body_schema": {
            "alert_id": "string",
            "device_id": "string",
            "severity": "string",
            "category": "string",
            "message": "string"
          }
        },
        "update_status": {
          "body_schema": {
            "release_id": "string",
            "device_id": "string",
            "phase": "string",
            "percent": "integer"
          }
        },
        "telemetry_live": {
          "body_schema": {
            "device_id": "string",
            "metrics": {
              "cpu": "string",
              "ram": "string",
              "disk_usage": "string"
            },
            "timestamp": "ISO8601"
          }
        }
      }
    },

    "Examples": {
      "SendLockScreenCommand": {
        "request": {
          "device_id": "PC001",
          "method": "lock_screen",
          "params": {},
          "sensitive": false,
          "client_message_id": "mobile-123",
          "two_factor_code": null
        },
        "response": {
          "status": "accepted",
          "reason": null,
          "command_id": "CMD-0001-uuid",
          "state": "queued",
          "queued_at": "2025-11-22T12:00:00Z"
        }
      },

      "CommandResultNotification_WebSocket": {
        "message": {
          "message_id": "ws-evt-001",
          "timestamp": "2025-11-22T12:00:11Z",
          "type": "command_update",
          "device_id": "PC001",
          "body": {
            "command_id": "CMD-0001-uuid",
            "state": "completed",
            "result_status": "ok",
            "error_code": null
          }
        }
      }
    }
  }
}
