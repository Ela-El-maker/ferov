name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # We test both to ensure cross-platform code compiles, 
        # but the pipe test only truly executes on Windows.
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake (no exec fallback)
        # We explicitly disable the dangerous exec fallback for security
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_EXEC_FALLBACK=OFF

      - name: Build
        run: cmake --build build --config Release --target ioctl_integration_test

      - name: Verify exec fallback disabled
        # Grep ensures the security gate is active in the build config
        run: |
          cd build
          grep -E "ENABLE_EXEC_FALLBACK:BOOL=OFF|ENABLE_EXEC_FALLBACK=OFF" CMakeCache.txt || (echo "Security Breach: ENABLE_EXEC_FALLBACK is not OFF" && exit 1)
        shell: bash

      - name: Run Integration Tests
        # On Windows, this runs the pipe mock and client handshake
        # On Ubuntu, the test code prints "SKIPPED" and exits with 0
        run: |
          cd build
          ctest -C Release --verbose --output-on-failure -R ioctl_integration_test
        shell: bash

      - name: Build Signed-Request Test
        run: |
          cd build
          cmake --build . --config Release --target ioctl_signed_test || true
        shell: bash

      - name: Run Signed-Request Integration Test (Windows only)
        if: runner.os == 'Windows'
        env:
          # These should be configured in the repository secrets for CI
          ED25519_PRIVATE_KEY_B64: ${{ secrets.CI_ED25519_SK_B64 }}
          KERNEL_CONTROLLER_PUBKEY_B64: ${{ secrets.CI_ED25519_PUB_B64 }}
        run: |
          cd build
          ctest -C Release --verbose --output-on-failure -R ioctl_signed_test || true
        shell: bash
